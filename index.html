<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’… Ø³ÛŒØ³ØªÙ… CRM Ø³Ø§Ù„Ù† Ù†Ø§Ø®Ù†</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #f3e8ff 100%);
            min-height: 100%;
        }
        
        html, body {
            height: 100%;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }
        
        .gradient-btn {
            background: linear-gradient(135deg, #f472b6, #c084fc);
            transition: all 0.3s ease;
        }
        
        .gradient-btn:hover {
            background: linear-gradient(135deg, #ec4899, #a855f7);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(244, 114, 182, 0.3);
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, #f472b6, #c084fc);
            color: white;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-1px);
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.2));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .customer-card {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
        }
        
        .customer-card:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }
        
        .badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .badge.vip {
            background: linear-gradient(135deg, #c084fc, #8b5cf6);
        }
        
        .badge.loyal {
            background: linear-gradient(135deg, #34d399, #10b981);
        }
        
        .badge.new {
            background: linear-gradient(135deg, #fb7185, #f43f5e);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            padding: 14px 18px;
            color: #374151;
            font-family: 'Vazirmatn', sans-serif;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #f472b6;
            box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.1);
            background: rgba(255, 255, 255, 0.5);
        }
        
        .modal {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        
        .qr-code {
            background: white;
            padding: 20px;
            border-radius: 16px;
            display: inline-block;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(25px);
                border-top: 1px solid rgba(255, 255, 255, 0.4);
                z-index: 50;
            }
            
            .main-content {
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body>
<style>
  #toast-container{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:99999;display:flex;flex-direction:column;gap:8px}
  .toast{min-width:260px;max-width:90vw;padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.15);color:#0b1b23;
    background:#fff;display:flex;align-items:center;gap:10px;font-size:14px;opacity:0;transform:translateY(-8px);animation:toast-in .25s forwards}
  .toast.success{border-left:6px solid #22c55e}
  .toast.error{border-left:6px solid #ef4444}
  .toast.warn{border-left:6px solid #f59e0b}
  .toast .title{font-weight:700;margin-inline-end:6px}
  @keyframes toast-in{to{opacity:1;transform:translateY(0)}}
  @keyframes toast-out{to{opacity:0;transform:translateY(-6px)}}
</style>
<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <div id="app" class="min-h-full">
        <!-- Login/Register Screen -->
        <div id="auth-screen" class="min-h-full flex items-center justify-center p-6">
            <div class="w-full max-w-md space-y-6">
                <!-- Logo -->
                <div class="text-center mb-8">
                    <div class="w-20 h-20 mx-auto rounded-full gradient-btn flex items-center justify-center text-white text-3xl mb-4">ğŸ’…</div>
                   <h1 class="text-2xl font-bold text-gray-800">Nasryn NailArt</h1>
                    <p class="text-gray-600 mt-2">Ø¨Ø§ Ø¹Ø´Ù‚ Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ Ø´Ù…Ø§ ğŸŒ¸</p>
                </div>

                <!-- Auth Tabs -->
                <div class="flex bg-white bg-opacity-30 rounded-2xl p-1 mb-6">
                    <button onclick="showAuthTab('customer-login')" class="auth-tab flex-1 py-3 px-4 rounded-xl font-medium transition-all" id="tab-customer-login">
                        ğŸ‘¤ ÙˆØ±ÙˆØ¯ Ù…Ø´ØªØ±ÛŒ
                    </button>
                    <button onclick="showAuthTab('customer-register')" class="auth-tab flex-1 py-3 px-4 rounded-xl font-medium transition-all" id="tab-customer-register">
                        ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
                    </button>
                    <button onclick="showAuthTab('admin-login')" class="auth-tab flex-1 py-3 px-4 rounded-xl font-medium transition-all" id="tab-admin-login">
                        âš™ï¸ Ø§Ø¯Ù…ÛŒÙ†
                    </button>
                </div>

                <!-- Customer Login -->
                <div id="customer-login-form" class="auth-form login-card rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 text-center">ÙˆØ±ÙˆØ¯ Ù…Ø´ØªØ±ÛŒ ğŸ‘¤</h3>
                    <div class="space-y-4">
                        <input type="tel" id="customer-login-phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" class="input-field w-full">
                        <button onclick="customerLogin()" class="gradient-btn text-white px-6 py-4 rounded-2xl w-full font-medium">
                            ÙˆØ±ÙˆØ¯ ğŸŒ¸
                        </button>
                    </div>
                </div>

                <!-- Customer Register -->
                <div id="customer-register-form" class="auth-form login-card rounded-2xl p-6 hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 text-center">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…Ø´ØªØ±ÛŒ ğŸ“</h3>
                    <div class="space-y-4">
                        <input type="text" id="customer-register-name" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" class="input-field w-full">
                        <input type="tel" id="customer-register-phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" class="input-field w-full">
                        <input type="text" id="customer-register-birthday" placeholder="ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ (Ù…Ø«Ø§Ù„: 1370/05/15)" class="input-field w-full" maxlength="10" oninput="formatPersianDate(this)">
                        <button onclick="customerRegister()" class="gradient-btn text-white px-6 py-4 rounded-2xl w-full font-medium">
                            Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… ğŸ’–
                        </button>
                    </div>
                </div>

                <!-- Admin Login -->
                <div id="admin-login-form" class="auth-form login-card rounded-2xl p-6 hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 text-center">ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ† âš™ï¸</h3>
                    <div class="space-y-4">
                        <input type="text" id="admin-username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" class="input-field w-full">
                        <input type="password" id="admin-password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" class="input-field w-full">
                        <button onclick="adminLogin()" class="gradient-btn text-white px-6 py-4 rounded-2xl w-full font-medium">
                            ÙˆØ±ÙˆØ¯ ğŸ”
                        </button>
                    </div>
                </div>


            </div>
        </div>

        <!-- Customer Panel -->
        <div id="customer-panel" class="hidden min-h-full">
            <!-- Customer Header -->
            <header class="glass-card rounded-b-3xl p-6 mb-6 sticky top-0 z-40">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full gradient-btn flex items-center justify-center text-white text-xl" id="customer-avatar">ğŸ’…</div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-800" id="customer-welcome">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h1>
                            <p class="text-sm text-gray-600">Ù¾Ù†Ù„ Ù…Ø´ØªØ±ÛŒ ğŸŒ¸</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="nav-btn px-4 py-2 rounded-xl text-sm font-medium">
                        Ø®Ø±ÙˆØ¬ ğŸšª
                    </button>
                </div>
            </header>

            <!-- Customer Navigation -->
            <nav class="hidden md:block mb-6">
                <div class="flex justify-center gap-2 px-6">
                    <button onclick="showCustomerSection('profile')" class="nav-btn active px-6 py-3 rounded-2xl font-medium" id="customer-nav-profile">
                        ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                    </button>
                    <button onclick="showCustomerSection('appointments')" class="nav-btn px-6 py-3 rounded-2xl font-medium" id="customer-nav-appointments">
                        ğŸ“… Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§
                    </button>
                    <button onclick="showCustomerSection('campaigns')" class="nav-btn px-6 py-3 rounded-2xl font-medium" id="customer-nav-campaigns">
                        ğŸ¯ Ú©Ù…Ù¾ÛŒÙ†â€ŒÙ‡Ø§
                    </button>
                </div>
            </nav>

            <!-- Customer Mobile Navigation -->
            <nav class="mobile-nav md:hidden">
                <div class="flex justify-around py-2">
                    <button onclick="showCustomerSection('profile')" class="nav-btn active p-3 rounded-xl" id="customer-mobile-nav-profile">
                        <div class="text-lg">ğŸ‘¤</div>
                        <div class="text-xs">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</div>
                    </button>
                    <button onclick="showCustomerSection('appointments')" class="nav-btn p-3 rounded-xl" id="customer-mobile-nav-appointments">
                        <div class="text-lg">ğŸ“…</div>
                        <div class="text-xs">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§</div>
                    </button>
                    <button onclick="showCustomerSection('campaigns')" class="nav-btn p-3 rounded-xl" id="customer-mobile-nav-campaigns">
                        <div class="text-lg">ğŸ¯</div>
                        <div class="text-xs">Ú©Ù…Ù¾ÛŒÙ†â€ŒÙ‡Ø§</div>
                    </button>
                </div>
            </nav>

            <!-- Customer Content -->
            <main class="main-content px-6">
                <!-- Customer Profile Section -->
                <section id="customer-profile-section" class="customer-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Profile Info -->
                        <div class="glass-card rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                                ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ
                            </h2>
                            <div id="customer-profile-info" class="space-y-4">
                                <!-- Profile info will be loaded here -->
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="glass-card rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                                ğŸ“Š Ø¢Ù…Ø§Ø± Ù…Ù†
                            </h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="stats-card rounded-xl p-4 text-center">
                                    <div class="text-2xl font-bold text-gray-800" id="customer-visits">0</div>
                                    <div class="text-sm text-gray-600">Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</div>
                                </div>
                                <div class="stats-card rounded-xl p-4 text-center">
                                    <div class="text-2xl font-bold text-gray-800" id="customer-balance">0</div>
                                    <div class="text-sm text-gray-600">Ø´Ø§Ø±Ú˜ (ØªÙˆÙ…Ø§Ù†)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- Social Media -->
                    <div class="glass-card rounded-2xl p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸ“± Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <a href="https://instagram.com/nail.nasryn" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 p-4 bg-gradient-to-r from-pink-100 to-purple-100 rounded-xl hover:from-pink-200 hover:to-purple-200 transition-all">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-r from-pink-500 to-purple-500 flex items-center justify-center text-white text-xl">
                                    ğŸ“·
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…</div>
                                    <div class="text-sm text-gray-600">@nail.nasryn</div>
                                </div>
                            </a>
                            
                            <a href="https://wa.me/09395975018" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 p-4 bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl hover:from-green-200 hover:to-emerald-200 transition-all">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center text-white text-xl">
                                    ğŸ’¬
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">ÙˆØ§ØªØ³â€ŒØ§Ù¾</div>
                                    <div class="text-sm text-gray-600">09395975018</div>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Cashback Program -->
                    <div class="glass-card rounded-2xl p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸ’° Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡
                        </h2>
                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl p-6">
                            <div class="text-3xl mb-4 text-center">ğŸ’°âœ¨</div>
                            <div class="text-lg font-bold text-gray-800 mb-4 text-center">Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯</div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-white bg-opacity-50 rounded-lg p-3 text-center">
                                    <div class="font-bold text-gray-800">Ø¯Ø±ØµØ¯ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§</div>
                                    <div class="text-2xl font-bold text-green-600" id="customer-cashback-rate">5%</div>
                                </div>
                                <div class="bg-white bg-opacity-50 rounded-lg p-3 text-center">
                                    <div class="font-bold text-gray-800">Ú©Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø±ÛŒØ§ÙØªÛŒ</div>
                                    <div class="text-2xl font-bold text-green-600" id="customer-total-cashback">0 ØªÙˆÙ…Ø§Ù†</div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-700 space-y-1">
                                <div>ğŸ¯ Ø¬Ù„Ø³Ù‡ Û³: +3% Ø§Ø¶Ø§ÙÛŒ</div>
                                <div>ğŸŒŸ Ø¬Ù„Ø³Ù‡ Ûµ: +5% Ø§Ø¶Ø§ÙÛŒ</div>
                                <div>ğŸ‘‘ Ø¬Ù„Ø³Ù‡ Û±Û°: +10% Ø§Ø¶Ø§ÙÛŒ (VIP)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Referral Program -->
                    <div class="glass-card rounded-2xl p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø¹Ø±ÙÛŒ Ø¯ÙˆØ³ØªØ§Ù†
                        </h2>
                        <div class="bg-gradient-to-r from-pink-100 to-purple-100 rounded-xl p-6 text-center">
                            <div class="text-3xl mb-4">ğŸ‘¥ğŸ’–</div>
                            <div class="text-lg font-bold text-gray-800 mb-2">Ø¬Ø§ÛŒØ²Ù‡ Ù…Ø¹Ø±ÙÛŒ Ø¯ÙˆØ³ØªØ§Ù†</div>
                            <div class="text-gray-700 mb-4">
                                Ø¨Ø§ Ù…Ø¹Ø±ÙÛŒ Û³ Ø¯ÙˆØ³Øª Ø¨Ù‡ Ø³Ø§Ù„Ù†ØŒ ÛŒÚ© Ø¬Ù„Ø³Ù‡ Ú©Ø§Ù…Ù„ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯!
                            </div>
                            <div class="text-sm text-gray-600">
                                ğŸ’¡ Ú©Ø§ÙÛŒØ³Øª Ø¯ÙˆØ³ØªØ§Ù†ØªØ§Ù† Ù‡Ù†Ú¯Ø§Ù… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…ØŒ Ù†Ø§Ù… Ø´Ù…Ø§ Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹Ø±Ù Ø°Ú©Ø± Ú©Ù†Ù†Ø¯
                            </div>
                        </div>
                    </div>

                    <!-- Service History -->
                    <div class="glass-card rounded-2xl p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸ“‹ Ø³Ø§Ø¨Ù‚Ù‡ Ø®Ø¯Ù…Ø§Øª
                        </h2>
                        <div id="customer-service-history" class="space-y-4">
                            <!-- Service history will be loaded here -->
                        </div>
                    </div>

                    <!-- Recent Appointments -->
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸ“… Ø¢Ø®Ø±ÛŒÙ† Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§
                        </h2>
                        <div id="customer-recent-appointments" class="space-y-4">
                            <!-- Recent appointments will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Customer Appointments Section -->
                <section id="customer-appointments-section" class="customer-section hidden">
                    <div class="glass-card rounded-2xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                ğŸ“… Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª
                            </h2>
                            <button onclick="showBookAppointmentModal()" class="gradient-btn text-white px-4 py-2 rounded-xl">
                                â• Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯
                            </button>
                        </div>
                        
                        <div id="customer-appointments-list" class="space-y-4">
                            <!-- Customer appointments will be loaded here -->
                        </div>
                    </div>
                </section>



                <!-- Customer Campaigns Section -->
                <section id="customer-campaigns-section" class="customer-section hidden">
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸ¯ Ú©Ù…Ù¾ÛŒÙ†â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
                        </h2>
                        <div id="customer-active-campaigns" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Active campaigns will be loaded here -->
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Admin Panel (Previous admin panel code remains the same) -->
        <div id="admin-panel" class="hidden min-h-full">
            <!-- Admin Header -->
            <header class="glass-card rounded-b-3xl p-6 mb-6 sticky top-0 z-40">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full gradient-btn flex items-center justify-center text-white text-xl">âš™ï¸</div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ù„Ù† Ù†Ø§Ø®Ù†</h1>
                            <p class="text-sm text-gray-600">Ø¨Ø§ Ø¹Ø´Ù‚ Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ Ø´Ù…Ø§ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ğŸŒ¸</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="nav-btn px-4 py-2 rounded-xl text-sm font-medium">
                            ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Excel
                        </button>
                        <button onclick="logout()" class="nav-btn px-4 py-2 rounded-xl text-sm font-medium">
                            Ø®Ø±ÙˆØ¬ ğŸšª
                        </button>
                    </div>
                </div>
            </header>

            <!-- Admin Navigation -->
            <nav class="hidden md:block mb-6">
                <div class="flex justify-center gap-2 px-6">
                    <button onclick="showAdminSection('dashboard')" class="nav-btn active px-6 py-3 rounded-2xl font-medium" id="admin-nav-dashboard">
                        ğŸ  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                    </button>
                    <button onclick="showAdminSection('customers')" class="nav-btn px-6 py-3 rounded-2xl font-medium" id="admin-nav-customers">
                        ğŸ‘¥ Ù…Ø´ØªØ±ÛŒØ§Ù†
                    </button>
                    <button onclick="showAdminSection('appointments')" class="nav-btn px-6 py-3 rounded-2xl font-medium" id="admin-nav-appointments">
                        ğŸ“… Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§
                    </button>
                    <button onclick="showAdminSection('services')" class="nav-btn px-6 py-3 rounded-2xl font-medium" id="admin-nav-services">
                        ğŸ“‹ Ø³Ø§Ø¨Ù‚Ù‡ Ø®Ø¯Ù…Ø§Øª
                    </button>
                    <button onclick="showAdminSection('messages')" class="nav-btn px-6 py-3 rounded-2xl font-medium" id="admin-nav-messages">
                        ğŸ’Œ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
                    </button>
                    <button onclick="showAdminSection('reports')" class="nav-btn px-6 py-3 rounded-2xl font-medium" id="admin-nav-reports">
                        ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´Ø§Øª
                    </button>
                    <button onclick="showAdminSection('loyalty')" class="nav-btn px-6 py-3 rounded-2xl font-medium" id="admin-nav-loyalty">
                        ğŸ ÙˆÙØ§Ø¯Ø§Ø±ÛŒ
                    </button>
                    <button onclick="showAdminSection('settings')" class="nav-btn px-6 py-3 rounded-2xl font-medium" id="admin-nav-settings">
                        âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                    </button>
                </div>
            </nav>

            <!-- Admin Mobile Navigation -->
            <nav class="mobile-nav md:hidden">
                <div class="flex justify-around py-2">
                    <button onclick="showAdminSection('dashboard')" class="nav-btn p-3 rounded-xl" id="admin-mobile-nav-dashboard">
                        <div class="text-lg">ğŸ </div>
                        <div class="text-xs">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</div>
                    </button>
                    <button onclick="showAdminSection('customers')" class="nav-btn p-3 rounded-xl" id="admin-mobile-nav-customers">
                        <div class="text-lg">ğŸ‘¥</div>
                        <div class="text-xs">Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
                    </button>
                    <button onclick="showAdminSection('appointments')" class="nav-btn p-3 rounded-xl" id="admin-mobile-nav-appointments">
                        <div class="text-lg">ğŸ“…</div>
                        <div class="text-xs">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§</div>
                    </button>
                    <button onclick="showAdminSection('services')" class="nav-btn p-3 rounded-xl" id="admin-mobile-nav-services">
                        <div class="text-lg">ğŸ“‹</div>
                        <div class="text-xs">Ø³Ø§Ø¨Ù‚Ù‡</div>
                    </button>
                    <button onclick="showAdminSection('messages')" class="nav-btn p-3 rounded-xl" id="admin-mobile-nav-messages">
                        <div class="text-lg">ğŸ’Œ</div>
                        <div class="text-xs">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</div>
                    </button>
                    <button onclick="showAdminSection('settings')" class="nav-btn p-3 rounded-xl" id="admin-mobile-nav-settings">
                        <div class="text-lg">âš™ï¸</div>
                        <div class="text-xs">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
                    </button>
                </div>
            </nav>

            <!-- Admin Content -->
            <main class="main-content px-6">
                <!-- Dashboard Section -->
                <section id="admin-dashboard-section" class="admin-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stats-card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="text-3xl">ğŸ‘¥</div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-gray-800" id="admin-total-customers">0</div>
                                    <div class="text-sm text-gray-600">Ú©Ù„ Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="text-3xl">ğŸ’°</div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-gray-800" id="admin-total-revenue">0</div>
                                    <div class="text-sm text-gray-600">Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯ (ØªÙˆÙ…Ø§Ù†)</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="text-3xl">ğŸ“…</div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-gray-800" id="admin-today-appointments">0</div>
                                    <div class="text-sm text-gray-600">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="text-3xl">â­</div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-gray-800" id="admin-vip-customers">0</div>
                                    <div class="text-sm text-gray-600">Ù…Ø´ØªØ±ÛŒØ§Ù† VIP</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activities -->
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸ• ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±
                        </h2>
                        <div id="admin-recent-activities" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                Ù‡Ù†ÙˆØ² ÙØ¹Ø§Ù„ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸŒ¸
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Other admin sections remain the same as before -->
                <!-- Customers Section -->
                <section id="admin-customers-section" class="admin-section hidden">
                    <div class="glass-card rounded-2xl p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±ÛŒØ§Ù†
                            </h2>
                            <input type="text" id="admin-customer-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù…Ø´ØªØ±ÛŒ..." class="input-field w-64">
                        </div>
                        
                        <div id="admin-customers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Customers will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Appointments Section -->
                <section id="admin-appointments-section" class="admin-section hidden">
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸ“… Ù…Ø¯ÛŒØ±ÛŒØª Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§
                        </h2>
                        
                        <div id="admin-appointments-list" class="space-y-4">
                            <!-- Appointments will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Service History Section -->
                <section id="admin-services-section" class="admin-section hidden">
                    <div class="glass-card rounded-2xl p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                ğŸ“‹ Ø«Ø¨Øª Ø³Ø§Ø¨Ù‚Ù‡ Ø®Ø¯Ù…Ø§Øª
                            </h2>
                            <button onclick="showAddServiceModal()" class="gradient-btn text-white px-4 py-2 rounded-xl">
                                â• Ø«Ø¨Øª Ø®Ø¯Ù…Øª Ø¬Ø¯ÛŒØ¯
                            </button>
                        </div>
                        
                        <div id="admin-services-list" class="space-y-4">
                            <!-- Service history will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Messages Section -->
                <section id="admin-messages-section" class="admin-section hidden">
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸ’Œ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ùˆ ØªØ¨Ù„ÛŒØºØ§Øª
                        </h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Send Message -->
                            <div class="customer-card rounded-xl p-6">
                                <h3 class="font-bold text-gray-800 mb-4">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…</h3>
                                <div class="space-y-4">
                                    <select id="admin-message-recipient" class="input-field w-full">
                                        <option value="all">Ù‡Ù…Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù†</option>
                                        <option value="vip">Ù…Ø´ØªØ±ÛŒØ§Ù† VIP</option>
                                        <option value="loyal">Ù…Ø´ØªØ±ÛŒØ§Ù† ÙˆÙØ§Ø¯Ø§Ø±</option>
                                        <option value="new">Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¬Ø¯ÛŒØ¯</option>
                                    </select>
                                    <textarea id="admin-message-content" placeholder="Ù…ØªÙ† Ù¾ÛŒØ§Ù…..." class="input-field w-full h-32 resize-none"></textarea>
                                    <button onclick="sendAdminMessage()" class="gradient-btn text-white px-6 py-3 rounded-xl w-full">
                                        ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Message Templates -->
                            <div class="customer-card rounded-xl p-6">
                                <h3 class="font-bold text-gray-800 mb-4">ğŸ“ Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡</h3>
                                <div class="space-y-3">
                                    <button onclick="useAdminTemplate('welcome')" class="w-full text-right p-3 rounded-lg bg-white bg-opacity-50 hover:bg-opacity-70 transition-all">
                                        ğŸŒ¸ Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
                                    </button>
                                    <button onclick="useAdminTemplate('reminder')" class="w-full text-right p-3 rounded-lg bg-white bg-opacity-50 hover:bg-opacity-70 transition-all">
                                        â° ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù†ÙˆØ¨Øª
                                    </button>
                                    <button onclick="useAdminTemplate('discount')" class="w-full text-right p-3 rounded-lg bg-white bg-opacity-50 hover:bg-opacity-70 transition-all">
                                        ğŸ Ú©Ø¯ ØªØ®ÙÛŒÙ ÙˆÛŒÚ˜Ù‡
                                    </button>
                                    <button onclick="useAdminTemplate('birthday')" class="w-full text-right p-3 rounded-lg bg-white bg-opacity-50 hover:bg-opacity-70 transition-all">
                                        ğŸ‚ ØªØ¨Ø±ÛŒÚ© ØªÙˆÙ„Ø¯
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Reports Section -->
                <section id="admin-reports-section" class="admin-section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Revenue Chart -->
                        <div class="glass-card rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                                ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø±Ø¢Ù…Ø¯
                            </h2>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-4 bg-white bg-opacity-30 rounded-xl">
                                    <span>Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²:</span>
                                    <span class="font-bold" id="admin-today-revenue">0 ØªÙˆÙ…Ø§Ù†</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white bg-opacity-30 rounded-xl">
                                    <span>Ø¯Ø±Ø¢Ù…Ø¯ Ø§ÛŒÙ† Ù…Ø§Ù‡:</span>
                                    <span class="font-bold" id="admin-month-revenue">0 ØªÙˆÙ…Ø§Ù†</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white bg-opacity-30 rounded-xl">
                                    <span>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø±Ø¢Ù…Ø¯ Ø±ÙˆØ²Ø§Ù†Ù‡:</span>
                                    <span class="font-bold" id="admin-avg-daily-revenue">0 ØªÙˆÙ…Ø§Ù†</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customer Stats -->
                        <div class="glass-card rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                                ğŸ‘¥ Ø¢Ù…Ø§Ø± Ù…Ø´ØªØ±ÛŒØ§Ù†
                            </h2>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-4 bg-white bg-opacity-30 rounded-xl">
                                    <span>Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¬Ø¯ÛŒØ¯ Ø§ÛŒÙ† Ù…Ø§Ù‡:</span>
                                    <span class="font-bold" id="admin-new-customers-month">0</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white bg-opacity-30 rounded-xl">
                                    <span>Ù…Ø´ØªØ±ÛŒØ§Ù† ÙØ¹Ø§Ù„:</span>
                                    <span class="font-bold" id="admin-active-customers">0</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white bg-opacity-30 rounded-xl">
                                    <span>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…Ø±Ø§Ø¬Ø¹Ø§Øª:</span>
                                    <span class="font-bold" id="admin-avg-visits">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Customers -->
                    <div class="glass-card rounded-2xl p-6 mt-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸ† Ø¨Ø±ØªØ±ÛŒÙ† Ù…Ø´ØªØ±ÛŒØ§Ù†
                        </h2>
                        <div id="admin-top-customers" class="space-y-3">
                            <!-- Top customers will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Loyalty Section -->
                <section id="admin-loyalty-section" class="admin-section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Loyalty Settings -->
                        <div class="glass-card rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                                ğŸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆÙØ§Ø¯Ø§Ø±ÛŒ
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø¯Ø±ØµØ¯ Ø§Ù…ØªÛŒØ§Ø² Ù‡Ø± Ù…Ø±Ø§Ø¬Ø¹Ù‡:</label>
                                    <input type="number" id="admin-loyalty-percentage" value="5" min="1" max="20" class="input-field w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø±ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„Ø³Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†:</label>
                                    <input type="number" id="admin-referral-count" value="3" min="1" max="10" class="input-field w-full">
                                </div>
                                <button onclick="saveAdminLoyaltySettings()" class="gradient-btn text-white px-6 py-3 rounded-xl w-full">
                                    ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                                </button>
                            </div>
                        </div>
                        
                        <!-- Create Campaign -->
                        <div class="glass-card rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                                ğŸ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù…Ù¾ÛŒÙ†
                            </h2>
                            <div class="space-y-4">
                                <input type="text" id="admin-campaign-name" placeholder="Ù†Ø§Ù… Ú©Ù…Ù¾ÛŒÙ†..." class="input-field w-full">
                                <input type="number" id="admin-campaign-discount" placeholder="Ø¯Ø±ØµØ¯ ØªØ®ÙÛŒÙ..." class="input-field w-full">
                                <input type="text" id="admin-campaign-expiry" placeholder="ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ (Ù…Ø«Ø§Ù„: 1403/10/15)" class="input-field w-full" maxlength="10" oninput="formatPersianDate(this)">
                                <textarea id="admin-campaign-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ù…Ù¾ÛŒÙ†..." class="input-field w-full h-24 resize-none"></textarea>
                                <button onclick="createAdminCampaign()" class="gradient-btn text-white px-6 py-3 rounded-xl w-full">
                                    ğŸš€ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù…Ù¾ÛŒÙ†
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Active Campaigns -->
                    <div class="glass-card rounded-2xl p-6 mt-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            ğŸª Ú©Ù…Ù¾ÛŒÙ†â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
                        </h2>
                        <div id="admin-active-campaigns" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                Ù‡Ù†ÙˆØ² Ú©Ù…Ù¾ÛŒÙ†ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸ
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="admin-settings-section" class="admin-section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- System Settings -->
                        <div class="glass-card rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                                âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ù†Ø§Ù… Ø³Ø§Ù„Ù†:</label>
                                    <input type="text" id="admin-salon-name" value="Ø³Ø§Ù„Ù† Ø²ÛŒØ¨Ø§ÛŒÛŒ Ù…Ø±ÛŒÙ… Ø¹Ù…Ø§Ø¯ÛŒ" class="input-field w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</label>
                                    <input type="text" id="admin-salon-phone" value="09395975018" class="input-field w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø¢Ø¯Ø±Ø³:</label>
                                    <textarea id="admin-salon-address" class="input-field w-full h-20 resize-none">Ø§ØµÙÙ‡Ø§Ù†ØŒ Ù…ÛŒØ¯Ø§Ù† Ø¢Ø²Ø§Ø¯ÛŒØŒ Ù…Ø¬ØªÙ…Ø¹ Ù¾Ø±Ù¾ÙˆÙ†Ù‡</textarea>
                                </div>
                                <button onclick="saveAdminSettings()" class="gradient-btn text-white px-6 py-3 rounded-xl w-full">
                                    ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                                </button>
                            </div>
                        </div>
                        
                        <!-- Data Management -->
                        <div class="glass-card rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                                ğŸ—„ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                            </h2>
                            <div class="space-y-4">
                                <button onclick="backupData()" class="gradient-btn text-white px-6 py-4 rounded-xl w-full">
                                    ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ
                                </button>
                                <button onclick="restoreData()" class="gradient-btn text-white px-6 py-4 rounded-xl w-full">
                                    ğŸ“¥ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
                                </button>
                                <button onclick="clearAllData()" class="bg-red-400 hover:bg-red-500 text-white px-6 py-4 rounded-xl transition-all w-full">
                                    ğŸ—‘ï¸ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Modals -->
        <!-- Book Appointment Modal -->
        <div id="book-appointment-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
            <div class="modal-content rounded-2xl p-6 w-full max-w-md">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    ğŸ“… Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯
                </h3>
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ù†ÙˆØ¨Øª:</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="book-appointment-date" placeholder="1403/09/15" class="input-field" maxlength="10" oninput="formatPersianDate(this)">
                            <input type="time" id="book-appointment-time" class="input-field">
                        </div>
                    </div>
                   <select id="book-appointment-service" class="input-field w-full">
                        <option value="manicure">Ù…Ø§Ù†ÛŒÚ©ÙˆØ± - 250,000 ØªÙˆÙ…Ø§Ù†</option>
                        <option value="laminate">Ø§Ø³ØªØ­Ú©Ø§Ù… Ø³Ø§Ø²ÛŒ Ù†Ø§Ø®Ù† Ø·Ø¨ÛŒØ¹ÛŒ (Ù„Ù…ÛŒÙ†Øª) - 450,000 ØªÙˆÙ…Ø§Ù†</option>
                        <option value="initial-extension">Ú©Ø§Ø´Øª Ø§ÙˆÙ„ÛŒÙ‡ - 600,000 ØªÙˆÙ…Ø§Ù†</option>
                        <option value="repair">ØªØ±Ù…ÛŒÙ… - 500,000 ØªÙˆÙ…Ø§Ù†</option>
                        <option value="colleague-repair">ØªØ±Ù…ÛŒÙ… Ù‡Ù…Ú©Ø§Ø± - 550,000 ØªÙˆÙ…Ø§Ù†</option>
                        <option value="gel-polish">Ú˜Ù„ Ù¾ÙˆÙ„ÛŒØ´ Ø¯Ø³Øª - 300,000 ØªÙˆÙ…Ø§Ù†</option>
                        <option value="shape-fix">Ø§ØµÙ„Ø§Ø­ ÙØ±Ù… Ùˆ Ù†Ø§Ø®Ù† Ø´Ú©Ø³ØªÙ‡ - 50,000 ØªÙˆÙ…Ø§Ù†</option>
                    </select>
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Ø®Ø¯Ù…Ø§Øª Ø§Ø¶Ø§ÙÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 p-2 bg-white bg-opacity-30 rounded-lg">
                                <input type="checkbox" id="additional-french" value="french" class="rounded">
                                <span class="text-sm">ÙØ±Ù†Ú† (+150,000)</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-white bg-opacity-30 rounded-lg">
                                <input type="checkbox" id="additional-ombre" value="ombre" class="rounded">
                                <span class="text-sm">Ø¢Ù…Ø¨Ø±Ù‡ (+180,000)</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-white bg-opacity-30 rounded-lg">
                                <input type="checkbox" id="additional-galaxy" value="galaxy-gel" class="rounded">
                                <span class="text-sm">Ù„Ø§Ú© Ú˜Ù„ Ú©Ù‡Ú©Ø´Ø§Ù†ÛŒ (+60,000)</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-white bg-opacity-30 rounded-lg">
                                <input type="checkbox" id="additional-lens" value="lens-chrome" class="rounded">
                                <span class="text-sm">Ø¯ÛŒØ²Ø§ÛŒÙ† Ù„Ù†Ø² Ùˆ Ú©Ø±ÙˆÙ… Ù‡Ø± Ø§Ù†Ú¯Ø´Øª (+20,000)</span>
                            </label>
                        </div>
                    </div>
                    <textarea id="book-appointment-notes" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§..." class="input-field w-full h-20 resize-none"></textarea>
                    <div class="flex gap-3">
                        <button onclick="bookAppointment()" class="gradient-btn text-white px-6 py-3 rounded-xl flex-1">
                            âœ… Ø±Ø²Ø±Ùˆ
                        </button>
                        <button onclick="closeModal('book-appointment-modal')" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-xl flex-1">
                            âŒ Ù„ØºÙˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Service Modal -->
        <div id="add-service-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
            <div class="modal-content rounded-2xl p-6 w-full max-w-md">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    ğŸ“‹ Ø«Ø¨Øª Ø®Ø¯Ù…Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡
                </h3>
                <div class="space-y-4">
                    <select id="service-customer-select" class="input-field w-full">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ...</option>
                    </select>
                    <select id="service-type-select" class="input-field w-full" onchange="toggleCustomServiceType()">
                         <option value="manicure">Ù…Ø§Ù†ÛŒÚ©ÙˆØ±</option>
                        <option value="laminate">Ø§Ø³ØªØ­Ú©Ø§Ù… Ø³Ø§Ø²ÛŒ Ù†Ø§Ø®Ù† Ø·Ø¨ÛŒØ¹ÛŒ (Ù„Ù…ÛŒÙ†Øª)</option>
                        <option value="initial-extension">Ú©Ø§Ø´Øª Ø§ÙˆÙ„ÛŒÙ‡</option>
                        <option value="repair">ØªØ±Ù…ÛŒÙ…</option>
                        <option value="colleague-repair">ØªØ±Ù…ÛŒÙ… Ù‡Ù…Ú©Ø§Ø±</option>
                        <option value="gel-polish">Ú˜Ù„ Ù¾ÙˆÙ„ÛŒØ´ Ø¯Ø³Øª</option>
                        <option value="shape-fix">Ø§ØµÙ„Ø§Ø­ ÙØ±Ù… Ùˆ Ù†Ø§Ø®Ù† Ø´Ú©Ø³ØªÙ‡</option>
                        <option value="other">Ø³Ø§ÛŒØ±</option>
                    </select>
                    <input type="text" id="service-custom-type" placeholder="Ù†ÙˆØ¹ Ø®Ø¯Ù…Øª (Ø¯Ø± ØµÙˆØ±Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ±)" class="input-field w-full hidden">
                    <input type="number" id="service-price" placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)" class="input-field w-full">
                    <textarea id="service-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®Ø¯Ù…Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡..." class="input-field w-full h-24 resize-none"></textarea>
                    <div class="flex gap-3">
                        <button onclick="addServiceRecord()" class="gradient-btn text-white px-6 py-3 rounded-xl flex-1">
                            âœ… Ø«Ø¨Øª
                        </button>
                        <button onclick="closeModal('add-service-modal')" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-xl flex-1">
                            âŒ Ù„ØºÙˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Panel Modal -->
        <div id="customer-panel-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
            <div class="modal-content rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2" id="customer-panel-title">
                        ğŸ‘¤ Ù¾Ù†Ù„ Ù…Ø´ØªØ±ÛŒ
                    </h3>
                    <button onclick="closeModal('customer-panel-modal')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-xl">
                        âŒ Ø¨Ø³ØªÙ†
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Customer Info -->
                    <div class="glass-card rounded-xl p-6">
                        <h4 class="font-bold text-gray-800 mb-4">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ</h4>
                        <div id="modal-customer-info" class="space-y-3">
                            <!-- Customer info will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Balance Management -->
                    <div class="glass-card rounded-xl p-6">
                        <h4 class="font-bold text-gray-800 mb-4">Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø³Ø§Ø¨</h4>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-white bg-opacity-30 rounded-xl">
                                <span>Ø´Ø§Ø±Ú˜ ÙØ¹Ù„ÛŒ:</span>
                                <span class="font-bold text-lg" id="modal-customer-balance">0 ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            
                            <div class="flex gap-2">
                                <input type="number" id="balance-amount" placeholder="Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)" class="input-field flex-1">
                                <button onclick="addCustomerBalance()" class="gradient-btn text-white px-4 py-2 rounded-xl">
                                    â• Ø´Ø§Ø±Ú˜
                                </button>
                            </div>
                            
                            <div class="flex gap-2">
                                <input type="number" id="deduct-amount" placeholder="Ù…Ø¨Ù„Øº Ú©Ø³Ø± (ØªÙˆÙ…Ø§Ù†)" class="input-field flex-1">
                                <button onclick="deductCustomerBalance()" class="bg-red-400 text-white px-4 py-2 rounded-xl">
                                    â– Ú©Ø³Ø±
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add Service -->
                    <div class="glass-card rounded-xl p-6">
                        <h4 class="font-bold text-gray-800 mb-4">Ø«Ø¨Øª Ø®Ø¯Ù…Øª Ø¬Ø¯ÛŒØ¯</h4>
                        <div class="space-y-4">
                            <select id="modal-service-type" class="input-field w-full" onchange="toggleModalCustomServiceType()">
                                <option value="manicure">Ù…Ø§Ù†ÛŒÚ©ÙˆØ±</option>
                                <option value="laminate">Ø§Ø³ØªØ­Ú©Ø§Ù… Ø³Ø§Ø²ÛŒ Ù†Ø§Ø®Ù† Ø·Ø¨ÛŒØ¹ÛŒ (Ù„Ù…ÛŒÙ†Øª)</option>
                                <option value="initial-extension">Ú©Ø§Ø´Øª Ø§ÙˆÙ„ÛŒÙ‡</option>
                                <option value="repair">ØªØ±Ù…ÛŒÙ…</option>
                                <option value="colleague-repair">ØªØ±Ù…ÛŒÙ… Ù‡Ù…Ú©Ø§Ø±</option>
                                <option value="gel-polish">Ú˜Ù„ Ù¾ÙˆÙ„ÛŒØ´ Ø¯Ø³Øª</option>
                                <option value="shape-fix">Ø§ØµÙ„Ø§Ø­ ÙØ±Ù… Ùˆ Ù†Ø§Ø®Ù† Ø´Ú©Ø³ØªÙ‡</option>
                                <option value="other">Ø³Ø§ÛŒØ±</option>
                            </select>
                            <input type="text" id="modal-custom-type" placeholder="Ù†ÙˆØ¹ Ø®Ø¯Ù…Øª (Ø¯Ø± ØµÙˆØ±Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ±)" class="input-field w-full hidden">
                            <input type="number" id="modal-service-price" placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)" class="input-field w-full">
                            <textarea id="modal-service-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®Ø¯Ù…Øª..." class="input-field w-full h-20 resize-none"></textarea>
                            <div class="flex gap-2">
                                <button onclick="addModalServiceRecord()" class="gradient-btn text-white px-4 py-2 rounded-xl flex-1">
                                    âœ… Ø«Ø¨Øª Ø®Ø¯Ù…Øª
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Service History -->
                    <div class="glass-card rounded-xl p-6">
                        <h4 class="font-bold text-gray-800 mb-4">Ø³Ø§Ø¨Ù‚Ù‡ Ø®Ø¯Ù…Ø§Øª</h4>
                        <div id="modal-service-history" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Service history will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancel Appointment Modal -->
        <div id="cancel-appointment-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
            <div class="modal-content rounded-2xl p-6 w-full max-w-md">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    âŒ Ù„ØºÙˆ Ù†ÙˆØ¨Øª
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø¯Ù„ÛŒÙ„ Ù„ØºÙˆ:</label>
                        <textarea id="cancel-reason" placeholder="Ø¯Ù„ÛŒÙ„ Ù„ØºÙˆ Ù†ÙˆØ¨Øª Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." class="input-field w-full h-24 resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø³Ø§Ø¹Øª Ø®Ø§Ù„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="suggested-date" placeholder="1403/09/20" class="input-field" maxlength="10" oninput="formatPersianDate(this)">
                            <input type="time" id="suggested-time" class="input-field">
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="confirmCancelAppointment()" class="bg-red-400 text-white px-6 py-3 rounded-xl flex-1">
                            âŒ Ù„ØºÙˆ Ù†ÙˆØ¨Øª
                        </button>
                        <button onclick="closeModal('cancel-appointment-modal')" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-xl flex-1">
                            Ø§Ù†ØµØ±Ø§Ù
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Storage
        let customers = [];
        let appointments = [];
        let settings = {};
        let campaigns = [];
        let serviceRecords = [];
        let currentUser = null;
        let userType = null; // 'customer' or 'admin'

       // Service prices
        const servicePrices = {
            'manicure': 250000,
            'laminate': 500000,
            'initial-extension': 600000,
            'repair': 500000,
            'colleague-repair': 550000,
            'gel-polish': 300000,
            'shape-fix': 50000,
        };

        // Additional services prices
        const additionalServicePrices = {
            'french': 150000,
            'ombre': 180000,
            'galaxy-gel': 60000,
            'lens-chrome': 20000
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            showAuthScreen();
            
            // Set default active tab
            showAuthTab('customer-login');
        });

        // Authentication functions
        function showAuthTab(tabName) {
            // Hide all forms
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('gradient-btn', 'text-white');
                tab.classList.add('text-gray-600');
            });
            
            // Show selected form
            document.getElementById(tabName + '-form').classList.remove('hidden');
            
            // Add active class to selected tab
            document.getElementById('tab-' + tabName).classList.add('gradient-btn', 'text-white');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-600');
        }

        function customerLogin() {
            const phone = document.getElementById('customer-login-phone').value.trim();
            
            if (!phone) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            const customer = customers.find(c => c.phone === phone);
            if (!customer) {
                showNotification('Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            currentUser = customer;
            userType = 'customer';
            showCustomerPanel();
            showNotification(`Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${customer.name}! ğŸŒ¸`, 'success');
        }

        function customerRegister() {
            const name = document.getElementById('customer-register-name').value.trim();
            const phone = document.getElementById('customer-register-phone').value.trim();
            const birthday = document.getElementById('customer-register-birthday').value;
            
            if (!name || !phone) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            // Check if customer already exists
            if (customers.find(c => c.phone === phone)) {
                showNotification('Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª', 'error');
                return;
            }
            
            const customer = {
                id: Date.now().toString(),
                name,
                phone,
                birthday,
                visits: 0,
                balance: 30000, // Welcome bonus
                createdAt: new Date().toISOString()
            };
            
            customers.push(customer);
            localStorage.setItem('nail-salon-customers', JSON.stringify(customers));
            
            currentUser = customer;
            userType = 'customer';
            showCustomerPanel();
            showNotification(`Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${customer.name}! ğŸ‰ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø§ Û³Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† Ø´Ø§Ø±Ú˜ Ø´Ø¯! ğŸ’°`, 'success');
        }

        function adminLogin() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value.trim();
            
            if (username === 'Ø§Ø¯Ù…ÛŒÙ†' && password === '123456789') {
                userType = 'admin';
                showAdminPanel();
                showNotification('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª! âš™ï¸', 'success');
            } else {
                showNotification('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error');
            }
        }

        function logout() {
            currentUser = null;
            userType = null;
            showAuthScreen();
            
            // Clear forms
            document.getElementById('customer-login-phone').value = '';
            document.getElementById('customer-register-name').value = '';
            document.getElementById('customer-register-phone').value = '';
            document.getElementById('customer-register-birthday').value = '';
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
            
            showNotification('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚! ğŸ‘‹', 'success');
        }

        // Screen management
        function showAuthScreen() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('customer-panel').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
        }

        function showCustomerPanel() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('customer-panel').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            
            loadCustomerData();
            showCustomerSection('profile');
        }

        function showAdminPanel() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('customer-panel').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            
            loadAdminData();
            showAdminSection('dashboard');
        }

        // Customer panel functions
        function loadCustomerData() {
            if (!currentUser) return;
            
            // Update header
            document.getElementById('customer-avatar').textContent = currentUser.name.charAt(0);
            document.getElementById('customer-welcome').textContent = `Ø³Ù„Ø§Ù… ${currentUser.name}`;
            
            // Update stats
            document.getElementById('customer-visits').textContent = currentUser.visits || 0;
            document.getElementById('customer-balance').textContent = (currentUser.balance || 0).toLocaleString();
            
            // Load profile info
            loadCustomerProfile();
            loadCustomerAppointments();

            loadCustomerCampaigns();
            loadCustomerServiceHistory();
        }

        function showCustomerSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.customer-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById('customer-' + sectionName + '-section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('#customer-panel .nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('customer-nav-' + sectionName)?.classList.add('active');
            document.getElementById('customer-mobile-nav-' + sectionName)?.classList.add('active');
        }

        function loadCustomerProfile() {
            if (!currentUser) return;
            
            const profileInfo = document.getElementById('customer-profile-info');
            profileInfo.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-30 rounded-xl">
                        <span class="text-gray-600">Ù†Ø§Ù…:</span>
                        <span class="font-medium">${currentUser.name}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-30 rounded-xl">
                        <span class="text-gray-600">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</span>
                        <span class="font-medium">${currentUser.phone}</span>
                    </div>
                    ${currentUser.birthday ? `
                        <div class="flex justify-between items-center p-3 bg-white bg-opacity-30 rounded-xl">
                            <span class="text-gray-600">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯:</span>
                            <span class="font-medium">${currentUser.birthday}</span>
                        </div>
                    ` : ''}
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-30 rounded-xl">
                        <span class="text-gray-600">Ø¹Ø¶ÙˆÛŒØª Ø§Ø²:</span>
                        <span class="font-medium">${new Date(currentUser.createdAt).toLocaleDateString('fa-IR')}</span>
                    </div>
                </div>
            `;
            
            // Update cashback info
            updateCustomerCashbackInfo();
            
            // Load recent appointments
            loadCustomerRecentAppointments();
        }

        function updateCustomerCashbackInfo() {
            if (!currentUser) return;
            
            // Calculate current cashback rate
            const baseCashback = parseInt(localStorage.getItem('base-cashback') || '5');
            const visit3Bonus = parseInt(localStorage.getItem('visit3-bonus') || '3');
            const visit5Bonus = parseInt(localStorage.getItem('visit5-bonus') || '5');
            const visit10Bonus = parseInt(localStorage.getItem('visit10-bonus') || '10');
            
            let totalCashbackPercent = baseCashback;
            const visits = currentUser.visits || 0;
            
            if (visits >= 10) {
                totalCashbackPercent += visit10Bonus;
            } else if (visits >= 5) {
                totalCashbackPercent += visit5Bonus;
            } else if (visits >= 3) {
                totalCashbackPercent += visit3Bonus;
            }
            
            // Calculate total cashback received
            const customerServices = serviceRecords.filter(s => s.customerId === currentUser.id);
            const totalCashback = customerServices.reduce((total, service) => total + (service.cashback || 0), 0);
            
            // Update display
            document.getElementById('customer-cashback-rate').textContent = totalCashbackPercent + '%';
            document.getElementById('customer-total-cashback').textContent = totalCashback.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
        }

        function loadCustomerRecentAppointments() {
            if (!currentUser) return;
            
            const customerAppointments = appointments
                .filter(a => a.customerId === currentUser.id)
                .sort((a, b) => new Date(b.datetime) - new Date(a.datetime))
                .slice(0, 3);
            
            const container = document.getElementById('customer-recent-appointments');
            
            if (customerAppointments.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Ù‡Ù†ÙˆØ² Ù†ÙˆØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸ“…</div>';
                return;
            }
            
            container.innerHTML = customerAppointments.map(appointment => {
                const displayDate = appointment.persianDate || new Date(appointment.datetime).toLocaleDateString('fa-IR');
                const displayTime = appointment.persianTime || new Date(appointment.datetime).toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit'});
                
                return `
                    <div class="flex items-center justify-between p-4 bg-white bg-opacity-30 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">ğŸ“…</div>
                            <div>
                                <div class="font-medium">${getServiceName(appointment.service)}</div>
                                <div class="text-sm text-gray-600">${date} - ${time}</div>
                            </div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-medium">${servicePrices[appointment.service].toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                            <div class="badge ${appointment.status}">${getStatusText(appointment.status)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadCustomerAppointments() {
            if (!currentUser) return;
            
            const customerAppointments = appointments
                .filter(a => a.customerId === currentUser.id)
                .sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            
            const container = document.getElementById('customer-appointments-list');
            
            if (customerAppointments.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Ù‡Ù†ÙˆØ² Ù†ÙˆØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸ“…</div>';
                return;
            }
            
            container.innerHTML = customerAppointments.map(appointment => {
                const displayDate = appointment.persianDate || new Date(appointment.datetime).toLocaleDateString('fa-IR');
                const displayTime = appointment.persianTime || new Date(appointment.datetime).toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit'});
                
                // Calculate total price including additional services
                let totalPrice = servicePrices[appointment.service] || 0;
                if (appointment.additionalServices && appointment.additionalServices.length > 0) {
                    appointment.additionalServices.forEach(service => {
                        totalPrice += additionalServicePrices[service] || 0;
                    });
                }
                
                return `
                    <div class="customer-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full gradient-btn flex items-center justify-center text-white text-xl">
                                    ğŸ“…
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">${getServiceName(appointment.service)}</div>
                                    <div class="text-sm text-gray-600">${displayDate} - ${displayTime}</div>
                                </div>
                            </div>
                            <div class="badge ${appointment.status}">${getStatusText(appointment.status)}</div>
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            ${appointment.additionalServices && appointment.additionalServices.length > 0 ? `
                                <div class="flex justify-between text-sm">
                                    <span>Ø®Ø¯Ù…Ø§Øª Ø§Ø¶Ø§ÙÛŒ:</span>
                                    <span class="font-medium">${appointment.additionalServices.map(s => getAdditionalServiceName(s)).join(', ')}</span>
                                </div>
                            ` : ''}
                            <div class="flex justify-between text-sm">
                                <span>Ù‚ÛŒÙ…Øª Ú©Ù„:</span>
                                <span class="font-medium">${totalPrice.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                            ${appointment.notes ? `
                                <div class="bg-white bg-opacity-30 rounded-lg p-3">
                                    <div class="text-sm text-gray-700">${appointment.notes}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${appointment.cancelReason ? `
                            <div class="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
                                <div class="text-sm text-red-700"><strong>Ø¯Ù„ÛŒÙ„ Ù„ØºÙˆ:</strong> ${appointment.cancelReason}</div>
                                ${appointment.suggestedDate && appointment.suggestedTime ? `
                                    <div class="text-sm text-blue-700 mt-2"><strong>Ø³Ø§Ø¹Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:</strong> ${appointment.suggestedDate} - ${appointment.suggestedTime}</div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${appointment.status === 'pending' ? `
                            <button onclick="cancelCustomerAppointment('${appointment.id}')" class="bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded-xl text-sm w-full transition-all">
                                âŒ Ù„ØºÙˆ Ù†ÙˆØ¨Øª
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }



        function loadCustomerCampaigns() {
            const activeCampaigns = campaigns.filter(c => c.active && new Date(c.expiry) > new Date());
            const container = document.getElementById('customer-active-campaigns');
            
            if (activeCampaigns.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ú©Ù…Ù¾ÛŒÙ† ÙØ¹Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ ğŸ</div>';
                return;
            }
            
            container.innerHTML = activeCampaigns.map(campaign => {
                const displayDate = campaign.persianExpiry || new Date(campaign.expiry).toLocaleDateString('fa-IR');
                
                return `
                    <div class="customer-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h4 class="font-bold text-gray-800">${campaign.name}</h4>
                                <p class="text-sm text-gray-600">${campaign.discount}% ØªØ®ÙÛŒÙ</p>
                            </div>
                            <div class="badge">${displayDate}</div>
                        </div>
                        
                        ${campaign.description ? `
                            <p class="text-gray-700 mb-4">${campaign.description}</p>
                        ` : ''}
                        
                        <button onclick="useCampaign('${campaign.id}')" class="gradient-btn text-white px-4 py-2 rounded-xl text-sm w-full">
                            ğŸ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ù…Ù¾ÛŒÙ†
                        </button>
                    </div>
                `;
            }).join('');
        }

        function loadCustomerServiceHistory() {
            if (!currentUser) return;
            
            const customerServices = serviceRecords
                .filter(s => s.customerId === currentUser.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('customer-service-history');
            
            if (customerServices.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Ù‡Ù†ÙˆØ² Ø³Ø§Ø¨Ù‚Ù‡ Ø®Ø¯Ù…Ø§ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸ“‹</div>';
                return;
            }
            
            container.innerHTML = customerServices.map(service => {
                const date = new Date(service.date).toLocaleDateString('fa-IR');
                
                return `
                    <div class="customer-card rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">ğŸ’…</div>
                                <div>
                                    <div class="font-medium">${service.serviceType === 'other' ? service.customServiceType : getServiceName(service.serviceType)}</div>
                                    <div class="text-sm text-gray-600">${date}</div>
                                </div>
                            </div>
                            <div class="text-left">
                                <div class="font-bold text-gray-800">${service.price.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                                ${service.cashback ? `<div class="text-sm text-green-600">+${service.cashback.toLocaleString()} Ø¨Ø§Ø²Ú¯Ø´Øª</div>` : ''}
                            </div>
                        </div>
                        
                        ${service.description ? `
                            <div class="bg-white bg-opacity-30 rounded-lg p-3">
                                <div class="text-sm text-gray-700">${service.description}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function showBookAppointmentModal() {
            document.getElementById('book-appointment-modal').classList.remove('hidden');
            document.getElementById('book-appointment-modal').classList.add('flex');
        }

        function bookAppointment() {
            if (!currentUser) return;
            
            const date = document.getElementById('book-appointment-date').value;
            const time = document.getElementById('book-appointment-time').value;
            const service = document.getElementById('book-appointment-service').value;
            const notes = document.getElementById('book-appointment-notes').value.trim();
            
            // Get additional services
            const additionalServices = [];
            if (document.getElementById('additional-french').checked) additionalServices.push('french');
            if (document.getElementById('additional-ombre').checked) additionalServices.push('ombre');
            if (document.getElementById('additional-galaxy').checked) additionalServices.push('galaxy-gel');
            if (document.getElementById('additional-lens').checked) additionalServices.push('lens-chrome');
            
            if (!date || !time || !service) {
                showNotification('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ®ØŒ Ø³Ø§Ø¹Øª Ùˆ Ø®Ø¯Ù…Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            // Convert Persian date to Gregorian for storage
            const datetime = convertPersianToGregorian(date, time);
            
            const appointment = {
                id: Date.now().toString(),
                customerId: currentUser.id,
                datetime: datetime.toISOString(),
                persianDate: date,
                persianTime: time,
                service,
                additionalServices,
                notes,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            appointments.push(appointment);
            localStorage.setItem('nail-salon-appointments', JSON.stringify(appointments));
            
            // Clear form
            document.getElementById('book-appointment-date').value = '';
            document.getElementById('book-appointment-time').value = '';
            document.getElementById('book-appointment-service').value = 'manicure';
            document.getElementById('book-appointment-notes').value = '';
            document.getElementById('additional-french').checked = false;
            document.getElementById('additional-ombre').checked = false;
            document.getElementById('additional-galaxy').checked = false;
            document.getElementById('additional-lens').checked = false;
            
            closeModal('book-appointment-modal');
            loadCustomerAppointments();
            loadCustomerRecentAppointments();
            showNotification('Ù†ÙˆØ¨Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯! Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ø¨Ø§Ø´ÛŒØ¯ ğŸ“…', 'success');
        }

        function cancelCustomerAppointment(appointmentId) {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ù†ÙˆØ¨Øª Ø±Ø§ Ù„ØºÙˆ Ú©Ù†ÛŒØ¯ØŸ')) {
                const appointment = appointments.find(a => a.id === appointmentId);
                if (appointment) {
                    appointment.status = 'cancelled';
                    localStorage.setItem('nail-salon-appointments', JSON.stringify(appointments));
                    loadCustomerAppointments();
                    loadCustomerRecentAppointments();
                    showNotification('Ù†ÙˆØ¨Øª Ù„ØºÙˆ Ø´Ø¯', 'success');
                }
            }
        }

        function shareReferralCode() {
            const referralCode = `REFER${currentUser.id}`;
            const message = `Ø³Ù„Ø§Ù…! Ù…Ù† Ø§Ø² Ø®Ø¯Ù…Ø§Øª Ø³Ø§Ù„Ù† Ø¨Ø³ÛŒØ§Ø± Ø±Ø§Ø¶ÛŒ Ù‡Ø³ØªÙ…. Ø¨Ø§ Ú©Ø¯ Ù…Ø¹Ø±ÙÛŒ ${referralCode} Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù† ØªØ§ Ù‡Ø± Ø¯ÙˆÛŒ Ù…Ø§ ØªØ®ÙÛŒÙ Ø¨Ú¯ÛŒØ±ÛŒÙ…! ğŸŒ¸ğŸ’…`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Ú©Ø¯ Ù…Ø¹Ø±ÙÛŒ Ø³Ø§Ù„Ù† ',
                    text: message
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                navigator.clipboard.writeText(message).then(() => {
                    showNotification('Ú©Ø¯ Ù…Ø¹Ø±ÙÛŒ Ú©Ù¾ÛŒ Ø´Ø¯! ğŸ“‹', 'success');
                });
            }
        }

        function useCampaign(campaignId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (campaign) {
                showNotification(`Ú©Ù…Ù¾ÛŒÙ† "${campaign.name}" ÙØ¹Ø§Ù„ Ø´Ø¯! ${campaign.discount}% ØªØ®ÙÛŒÙ Ø¯Ø± Ù†ÙˆØ¨Øª Ø¨Ø¹Ø¯ÛŒ Ø´Ù…Ø§ Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ğŸ`, 'success');
            }
        }

        // Admin panel functions (simplified versions of previous functions)
        function loadAdminData() {
            updateAdminStats();
            loadAdminRecentActivities();
        }

        function showAdminSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById('admin-' + sectionName + '-section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('#admin-panel .nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('admin-nav-' + sectionName)?.classList.add('active');
            document.getElementById('admin-mobile-nav-' + sectionName)?.classList.add('active');
            
            // Load section data
            switch(sectionName) {
                case 'dashboard':
                    loadAdminDashboard();
                    break;
                case 'customers':
                    loadAdminCustomers();
                    break;
                case 'appointments':
                    loadAdminAppointments();
                    break;
                case 'reports':
                    loadAdminReports();
                    break;
                case 'services':
                    loadAdminServices();
                    break;
                case 'loyalty':
                    loadAdminLoyalty();
                    break;
            }
        }

        function updateAdminStats() {
            document.getElementById('admin-total-customers').textContent = customers.length;
            document.getElementById('admin-total-revenue').textContent = calculateTotalRevenue().toLocaleString();
            document.getElementById('admin-today-appointments').textContent = getTodayAppointments().length;
            document.getElementById('admin-vip-customers').textContent = getVIPCustomers().length;
        }

        function loadAdminDashboard() {
            updateAdminStats();
            loadAdminRecentActivities();
        }

        function loadAdminRecentActivities() {
            const activitiesContainer = document.getElementById('admin-recent-activities');
            const recentAppointments = appointments
                .sort((a, b) => new Date(b.datetime) - new Date(a.datetime))
                .slice(0, 5);
            
            if (recentAppointments.length === 0) {
                activitiesContainer.innerHTML = '<div class="text-center text-gray-500 py-8">Ù‡Ù†ÙˆØ² ÙØ¹Ø§Ù„ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸŒ¸</div>';
                return;
            }
            
            activitiesContainer.innerHTML = recentAppointments.map(appointment => {
                const customer = customers.find(c => c.id === appointment.customerId);
                const date = new Date(appointment.datetime).toLocaleDateString('fa-IR');
                const time = new Date(appointment.datetime).toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit'});
                
                return `
                    <div class="flex items-center justify-between p-4 bg-white bg-opacity-30 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">ğŸ“…</div>
                            <div>
                                <div class="font-medium">${customer?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</div>
                                <div class="text-sm text-gray-600">${getServiceName(appointment.service)}</div>
                            </div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-medium">${date}</div>
                            <div class="text-sm text-gray-600">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadAdminCustomers() {
            const container = document.getElementById('admin-customers-list');
            
            if (customers.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Ù‡Ù†ÙˆØ² Ù…Ø´ØªØ±ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸ‘¥</div>';
                return;
            }
            
            container.innerHTML = customers.map(customer => `
                <div class="customer-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full gradient-btn flex items-center justify-center text-white text-xl">
                                ${customer.name.charAt(0)}
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">${customer.name}</div>
                                <div class="text-sm text-gray-600">${customer.phone}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span>Ù…Ø±Ø§Ø¬Ø¹Ø§Øª:</span>
                            <span class="font-medium">${customer.visits || 0} Ø¨Ø§Ø±</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Ø´Ø§Ø±Ú˜:</span>
                            <span class="font-medium">${(customer.balance || 0).toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                    </div>
                    
                    <button onclick="openCustomerPanel('${customer.id}')" class="gradient-btn text-white px-4 py-2 rounded-xl w-full">
                        ğŸ‘¤ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ù†Ù„ Ù…Ø´ØªØ±ÛŒ
                    </button>
                </div>
            `).join('');
        }

        function loadAdminAppointments() {
            const container = document.getElementById('admin-appointments-list');
            
            if (appointments.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Ù‡Ù†ÙˆØ² Ù†ÙˆØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸ“…</div>';
                return;
            }
            
            const sortedAppointments = appointments.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            
            container.innerHTML = sortedAppointments.map(appointment => {
                const customer = customers.find(c => c.id === appointment.customerId);
                const displayDate = appointment.persianDate || new Date(appointment.datetime).toLocaleDateString('fa-IR');
                const displayTime = appointment.persianTime || new Date(appointment.datetime).toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit'});
                
                // Calculate total price including additional services
                let totalPrice = servicePrices[appointment.service] || 0;
                if (appointment.additionalServices && appointment.additionalServices.length > 0) {
                    appointment.additionalServices.forEach(service => {
                        totalPrice += additionalServicePrices[service] || 0;
                    });
                }
                
                return `
                    <div class="customer-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full gradient-btn flex items-center justify-center text-white text-xl">
                                    ğŸ“…
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">${customer?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</div>
                                    <div class="text-sm text-gray-600">${customer?.phone || ''}</div>
                                </div>
                            </div>
                            <div class="badge ${appointment.status}">${getStatusText(appointment.status)}</div>
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span>Ø®Ø¯Ù…Øª:</span>
                                <span class="font-medium">${getServiceName(appointment.service)}</span>
                            </div>
                            ${appointment.additionalServices && appointment.additionalServices.length > 0 ? `
                                <div class="flex justify-between text-sm">
                                    <span>Ø®Ø¯Ù…Ø§Øª Ø§Ø¶Ø§ÙÛŒ:</span>
                                    <span class="font-medium">${appointment.additionalServices.map(s => getAdditionalServiceName(s)).join(', ')}</span>
                                </div>
                            ` : ''}
                            <div class="flex justify-between text-sm">
                                <span>ØªØ§Ø±ÛŒØ®:</span>
                                <span class="font-medium">${displayDate}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Ø³Ø§Ø¹Øª:</span>
                                <span class="font-medium">${displayTime}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Ù‚ÛŒÙ…Øª Ú©Ù„:</span>
                                <span class="font-medium">${totalPrice.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                            </div>
                        </div>
                        
                        ${appointment.notes ? `
                            <div class="bg-white bg-opacity-30 rounded-lg p-3 mb-4">
                                <div class="text-sm text-gray-700">${appointment.notes}</div>
                            </div>
                        ` : ''}
                        
                        ${appointment.cancelReason ? `
                            <div class="bg-red-100 border border-red-300 rounded-lg p-3 mb-4">
                                <div class="text-sm text-red-700"><strong>Ø¯Ù„ÛŒÙ„ Ù„ØºÙˆ:</strong> ${appointment.cancelReason}</div>
                            </div>
                        ` : ''}
                        
                        <div class="flex gap-2">
                            ${appointment.status === 'pending' ? `
                                <button onclick="confirmAdminAppointment('${appointment.id}')" class="gradient-btn text-white px-3 py-2 rounded-lg text-sm flex-1">
                                    âœ… ØªØ§ÛŒÛŒØ¯
                                </button>
                                <button onclick="showCancelAppointmentModal('${appointment.id}')" class="bg-red-400 text-white px-3 py-2 rounded-lg text-sm flex-1">
                                    âŒ Ù„ØºÙˆ
                                </button>
                            ` : appointment.status === 'confirmed' ? `
                                <button onclick="completeAdminAppointment('${appointment.id}')" class="gradient-btn text-white px-3 py-2 rounded-lg text-sm flex-1">
                                    âœ… ØªÚ©Ù…ÛŒÙ„
                                </button>
                                <button onclick="showCancelAppointmentModal('${appointment.id}')" class="bg-red-400 text-white px-3 py-2 rounded-lg text-sm flex-1">
                                    âŒ Ù„ØºÙˆ
                                </button>
                            ` : `
                                <button onclick="deleteAdminAppointment('${appointment.id}')" class="bg-red-400 text-white px-3 py-2 rounded-lg text-sm">
                                    ğŸ—‘ï¸ Ø­Ø°Ù
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Admin appointment management
        let selectedAppointmentId = null;

        function confirmAdminAppointment(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (appointment) {
                appointment.status = 'confirmed';
                localStorage.setItem('nail-salon-appointments', JSON.stringify(appointments));
                loadAdminAppointments();
                
                // Refresh customer data if they're logged in
                if (currentUser && currentUser.id === appointment.customerId) {
                    loadCustomerAppointments();
                    loadCustomerRecentAppointments();
                }
                
                showNotification('Ù†ÙˆØ¨Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯! âœ…', 'success');
            }
        }

        function completeAdminAppointment(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (appointment) {
                appointment.status = 'completed';
                
                // Update customer stats
                const customer = customers.find(c => c.id === appointment.customerId);
                if (customer) {
                    customer.visits = (customer.visits || 0) + 1;
                }
                
                localStorage.setItem('nail-salon-appointments', JSON.stringify(appointments));
                localStorage.setItem('nail-salon-customers', JSON.stringify(customers));
                loadAdminAppointments();
                updateAdminStats();
                
                // Refresh customer data if they're logged in
                if (currentUser && currentUser.id === appointment.customerId) {
                    loadCustomerAppointments();
                    loadCustomerRecentAppointments();
                    loadCustomerData();
                }
                
                showNotification('Ù†ÙˆØ¨Øª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯! ğŸ‰', 'success');
            }
        }

        function showCancelAppointmentModal(appointmentId) {
            selectedAppointmentId = appointmentId;
            document.getElementById('cancel-reason').value = '';
            document.getElementById('suggested-date').value = '';
            document.getElementById('suggested-time').value = '';
            document.getElementById('cancel-appointment-modal').classList.remove('hidden');
            document.getElementById('cancel-appointment-modal').classList.add('flex');
        }

        function confirmCancelAppointment() {
            if (!selectedAppointmentId) return;
            
            const cancelReason = document.getElementById('cancel-reason').value.trim();
            const suggestedDate = document.getElementById('suggested-date').value;
            const suggestedTime = document.getElementById('suggested-time').value;
            
            if (!cancelReason) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ø¯Ù„ÛŒÙ„ Ù„ØºÙˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            const appointment = appointments.find(a => a.id === selectedAppointmentId);
            if (appointment) {
                appointment.status = 'cancelled';
                appointment.cancelReason = cancelReason;
                
                if (suggestedDate && suggestedTime) {
                    appointment.suggestedDate = suggestedDate;
                    appointment.suggestedTime = suggestedTime;
                }
                
                localStorage.setItem('nail-salon-appointments', JSON.stringify(appointments));
                
                closeModal('cancel-appointment-modal');
                loadAdminAppointments();
                
                // Refresh customer data if they're logged in
                if (currentUser && currentUser.id === appointment.customerId) {
                    loadCustomerAppointments();
                    loadCustomerRecentAppointments();
                }
                
                showNotification('Ù†ÙˆØ¨Øª Ù„ØºÙˆ Ø´Ø¯ Ùˆ Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ ğŸ“¤', 'success');
            }
            
            selectedAppointmentId = null;
        }

        function deleteAdminAppointment(appointmentId) {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ù†ÙˆØ¨Øª Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) {
                appointments = appointments.filter(a => a.id !== appointmentId);
                localStorage.setItem('nail-salon-appointments', JSON.stringify(appointments));
                loadAdminAppointments();
                updateAdminStats();
                
                // Refresh customer data if they're logged in
                if (currentUser) {
                    loadCustomerAppointments();
                    loadCustomerRecentAppointments();
                }
                
                showNotification('Ù†ÙˆØ¨Øª Ø­Ø°Ù Ø´Ø¯', 'success');
            }
        }

        let selectedCustomerId = null;

        function openCustomerPanel(customerId) {
            selectedCustomerId = customerId;
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Update modal title
            document.getElementById('customer-panel-title').textContent = `ğŸ‘¤ Ù¾Ù†Ù„ ${customer.name}`;
            
            // Load customer info
            loadModalCustomerInfo(customer);
            
            // Load service history
            loadModalServiceHistory(customerId);
            
            // Show modal
            document.getElementById('customer-panel-modal').classList.remove('hidden');
            document.getElementById('customer-panel-modal').classList.add('flex');
        }

        function loadModalCustomerInfo(customer) {
            const container = document.getElementById('modal-customer-info');
            container.innerHTML = `
                <div class="flex justify-between items-center p-3 bg-white bg-opacity-30 rounded-xl">
                    <span class="text-gray-600">Ù†Ø§Ù…:</span>
                    <span class="font-medium">${customer.name}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-white bg-opacity-30 rounded-xl">
                    <span class="text-gray-600">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</span>
                    <span class="font-medium">${customer.phone}</span>
                </div>
                ${customer.birthday ? `
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-30 rounded-xl">
                        <span class="text-gray-600">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯:</span>
                        <span class="font-medium">${customer.birthday}</span>
                    </div>
                ` : ''}
                <div class="flex justify-between items-center p-3 bg-white bg-opacity-30 rounded-xl">
                    <span class="text-gray-600">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª:</span>
                    <span class="font-medium">${customer.visits || 0} Ø¨Ø§Ø±</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-white bg-opacity-30 rounded-xl">
                    <span class="text-gray-600">Ø¹Ø¶ÙˆÛŒØª Ø§Ø²:</span>
                    <span class="font-medium">${new Date(customer.createdAt).toLocaleDateString('fa-IR')}</span>
                </div>
            `;
            
            // Update balance display
            document.getElementById('modal-customer-balance').textContent = (customer.balance || 0).toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
        }

        function loadModalServiceHistory(customerId) {
            const customerServices = serviceRecords
                .filter(s => s.customerId === customerId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('modal-service-history');
            
            if (customerServices.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Ù‡Ù†ÙˆØ² Ø³Ø§Ø¨Ù‚Ù‡ Ø®Ø¯Ù…Ø§ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                return;
            }
            
            container.innerHTML = customerServices.map(service => {
                const date = new Date(service.date).toLocaleDateString('fa-IR');
                const serviceName = service.serviceType === 'other' ? service.customServiceType : getServiceName(service.serviceType);
                
                return `
                    <div class="bg-white bg-opacity-30 rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">${serviceName}</span>
                            <div class="text-left">
                                <div class="font-bold">${service.price.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                                ${service.cashback ? `<div class="text-sm text-green-600">+${service.cashback.toLocaleString()} Ø¨Ø§Ø²Ú¯Ø´Øª</div>` : ''}
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">${date}</div>
                        ${service.description ? `<div class="text-sm text-gray-700">${service.description}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function addCustomerBalance() {
            const amount = document.getElementById('balance-amount').value;
            if (!amount || isNaN(amount) || !selectedCustomerId) return;
            
            const customer = customers.find(c => c.id === selectedCustomerId);
            if (customer) {
                customer.balance = (customer.balance || 0) + parseInt(amount);
                localStorage.setItem('nail-salon-customers', JSON.stringify(customers));
                
                // Update displays
                loadModalCustomerInfo(customer);
                loadAdminCustomers();
                document.getElementById('balance-amount').value = '';
                
                showNotification(`${parseInt(amount).toLocaleString()} ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ Ø­Ø³Ø§Ø¨ ${customer.name} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯! ğŸ’°`, 'success');
            }
        }

        function deductCustomerBalance() {
            const amount = document.getElementById('deduct-amount').value;
            if (!amount || isNaN(amount) || !selectedCustomerId) return;
            
            const customer = customers.find(c => c.id === selectedCustomerId);
            if (customer) {
                const deductAmount = parseInt(amount);
                if ((customer.balance || 0) < deductAmount) {
                    showNotification('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!', 'error');
                    return;
                }
                
                customer.balance = (customer.balance || 0) - deductAmount;
                localStorage.setItem('nail-salon-customers', JSON.stringify(customers));
                
                // Update displays
                loadModalCustomerInfo(customer);
                loadAdminCustomers();
                document.getElementById('deduct-amount').value = '';
                
                showNotification(`${deductAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù† Ø§Ø² Ø­Ø³Ø§Ø¨ ${customer.name} Ú©Ø³Ø± Ø´Ø¯! ğŸ’³`, 'success');
            }
        }

        function toggleModalCustomServiceType() {
            const serviceType = document.getElementById('modal-service-type').value;
            const customTypeInput = document.getElementById('modal-custom-type');
            
            if (serviceType === 'other') {
                customTypeInput.classList.remove('hidden');
            } else {
                customTypeInput.classList.add('hidden');
                customTypeInput.value = '';
            }
        }

        function addModalServiceRecord() {
            if (!selectedCustomerId) return;
            
            const serviceType = document.getElementById('modal-service-type').value;
            const customServiceType = document.getElementById('modal-custom-type').value.trim();
            const price = document.getElementById('modal-service-price').value;
            const description = document.getElementById('modal-service-description').value.trim();
            
            if (!serviceType || !price || !description) {
                showNotification('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            if (serviceType === 'other' && !customServiceType) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ø®Ø¯Ù…Øª Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            const servicePrice = parseInt(price);
            const cashback = calculateCashback(selectedCustomerId, servicePrice);
            
            const serviceRecord = {
                id: Date.now().toString(),
                customerId: selectedCustomerId,
                serviceType,
                customServiceType: serviceType === 'other' ? customServiceType : '',
                price: servicePrice,
                cashback: cashback,
                description,
                date: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };
            
            serviceRecords.push(serviceRecord);
            localStorage.setItem('nail-salon-service-records', JSON.stringify(serviceRecords));
            
            // Update customer stats and add cashback
            const customer = customers.find(c => c.id === selectedCustomerId);
            if (customer) {
                customer.visits = (customer.visits || 0) + 1;
                customer.balance = (customer.balance || 0) + cashback;
                localStorage.setItem('nail-salon-customers', JSON.stringify(customers));
            }
            
            // Clear form
            clearModalServiceForm();
            
            // Reload displays
            loadModalCustomerInfo(customer);
            loadModalServiceHistory(selectedCustomerId);
            loadAdminCustomers();
            updateAdminStats();
            
            showNotification(`Ø®Ø¯Ù…Øª Ø«Ø¨Øª Ø´Ø¯! ${cashback.toLocaleString()} ØªÙˆÙ…Ø§Ù† Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯! ğŸ’°`, 'success');
        }

        function addModalServiceFromBalance() {
            if (!selectedCustomerId) return;
            
            const serviceType = document.getElementById('modal-service-type').value;
            const customServiceType = document.getElementById('modal-custom-type').value.trim();
            const price = document.getElementById('modal-service-price').value;
            const description = document.getElementById('modal-service-description').value.trim();
            
            if (!serviceType || !price || !description) {
                showNotification('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            if (serviceType === 'other' && !customServiceType) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ø®Ø¯Ù…Øª Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id === selectedCustomerId);
            const servicePrice = parseInt(price);
            
            if (!customer || (customer.balance || 0) < servicePrice) {
                showNotification('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!', 'error');
                return;
            }
            
            // Deduct from balance
            customer.balance = (customer.balance || 0) - servicePrice;
            
            const serviceRecord = {
                id: Date.now().toString(),
                customerId: selectedCustomerId,
                serviceType,
                customServiceType: serviceType === 'other' ? customServiceType : '',
                price: servicePrice,
                description: description + ' (Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨)',
                date: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };
            
            serviceRecords.push(serviceRecord);
            customer.visits = (customer.visits || 0) + 1;
            
            localStorage.setItem('nail-salon-service-records', JSON.stringify(serviceRecords));
            localStorage.setItem('nail-salon-customers', JSON.stringify(customers));
            
            // Clear form
            clearModalServiceForm();
            
            // Reload displays
            loadModalCustomerInfo(customer);
            loadModalServiceHistory(selectedCustomerId);
            loadAdminCustomers();
            updateAdminStats();
            
            showNotification(`Ø®Ø¯Ù…Øª Ø«Ø¨Øª Ø´Ø¯ Ùˆ ${servicePrice.toLocaleString()} ØªÙˆÙ…Ø§Ù† Ø§Ø² Ø´Ø§Ø±Ú˜ Ú©Ø³Ø± Ø´Ø¯! ğŸ’³`, 'success');
        }

        function clearModalServiceForm() {
            document.getElementById('modal-service-type').value = 'manicure';
            document.getElementById('modal-custom-type').value = '';
            document.getElementById('modal-custom-type').classList.add('hidden');
            document.getElementById('modal-service-price').value = '';
            document.getElementById('modal-service-description').value = '';
        }

        // Message functions
        function sendAdminMessage() {
            const recipient = document.getElementById('admin-message-recipient').value;
            const content = document.getElementById('admin-message-content').value.trim();
            
            if (!content) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            let targetCustomers = [];
            switch(recipient) {
                case 'all':
                    targetCustomers = customers;
                    break;
                case 'vip':
                    targetCustomers = customers.filter(c => c.status === 'vip');
                    break;
                case 'loyal':
                    targetCustomers = customers.filter(c => c.status === 'loyal');
                    break;
                case 'new':
                    targetCustomers = customers.filter(c => c.status === 'new');
                    break;
            }
            
            // Simulate sending message
            document.getElementById('admin-message-content').value = '';
            showNotification(`Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ ${targetCustomers.length} Ù…Ø´ØªØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯! ğŸ“¤`, 'success');
        }

        function useAdminTemplate(templateType) {
            const templates = {
                welcome: 'Ø³Ù„Ø§Ù… Ø¹Ø²ÛŒØ²! ğŸŒ¸ Ø¨Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ø¨Ø²Ø±Ú¯ Ø³Ø§Ù„Ù† Ø²ÛŒØ¨Ø§ÛŒÛŒ Ù…Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ø§Ù…ÛŒØ¯ÙˆØ§Ø±ÛŒÙ… ØªØ¬Ø±Ø¨Ù‡â€ŒØ§ÛŒ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯! ğŸ’…âœ¨',
                reminder: 'Ø³Ù„Ø§Ù… Ú¯Ù„! ğŸŒº ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ù†ÙˆØ¨Øª Ø´Ù…Ø§ ÙØ±Ø¯Ø§ Ø³Ø§Ø¹Øª ... Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯. Ù…Ù†ØªØ¸Ø±ØªØ§Ù† Ù‡Ø³ØªÛŒÙ…! ğŸ“…ğŸ’–',
                discount: 'Ø®Ø¨Ø± Ø®ÙˆØ´! ğŸ‰ Ú©Ø¯ ØªØ®ÙÛŒÙ ÙˆÛŒÚ˜Ù‡ Ø´Ù…Ø§: BEAUTY20 - Û²Û°Ùª ØªØ®ÙÛŒÙ Ø±ÙˆÛŒ ØªÙ…Ø§Ù… Ø®Ø¯Ù…Ø§Øª ØªØ§ Ù¾Ø§ÛŒØ§Ù† Ù…Ø§Ù‡! ğŸğŸ’…',
                birthday: 'ØªÙˆÙ„Ø¯Øª Ù…Ø¨Ø§Ø±Ú© Ø¹Ø²ÛŒØ²! ğŸ‚ğŸ‰ Ø¨Ù‡ Ù…Ù†Ø§Ø³Ø¨Øª ØªÙˆÙ„Ø¯ØªØŒ ÛŒÚ© Ø¬Ù„Ø³Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ø±Ø§Øª Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÛŒÙ…! ğŸğŸ’…'
            };
            
            document.getElementById('admin-message-content').value = templates[templateType];
        }

        // Reports functions
        function loadAdminServices() {
            const container = document.getElementById('admin-services-list');
            
            if (serviceRecords.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Ù‡Ù†ÙˆØ² Ø³Ø§Ø¨Ù‚Ù‡ Ø®Ø¯Ù…Ø§ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸ“‹</div>';
                return;
            }
            
            const sortedServices = serviceRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedServices.map(service => {
                const customer = customers.find(c => c.id === service.customerId);
                const date = new Date(service.date).toLocaleDateString('fa-IR');
                const serviceName = service.serviceType === 'other' ? service.customServiceType : getServiceName(service.serviceType);
                
                return `
                    <div class="customer-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full gradient-btn flex items-center justify-center text-white text-xl">
                                    ğŸ’…
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">${customer?.name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</div>
                                    <div class="text-sm text-gray-600">${customer?.phone || ''}</div>
                                </div>
                            </div>
                            <div class="text-left">
                                <div class="font-bold text-gray-800">${service.price.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                                ${service.cashback ? `<div class="text-sm text-green-600">+${service.cashback.toLocaleString()} Ø¨Ø§Ø²Ú¯Ø´Øª</div>` : ''}
                                <div class="text-sm text-gray-600">${date}</div>
                            </div>
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span>Ø®Ø¯Ù…Øª:</span>
                                <span class="font-medium">${serviceName}</span>
                            </div>
                        </div>
                        
                        <div class="bg-white bg-opacity-30 rounded-lg p-3">
                            <div class="text-sm text-gray-700">${service.description}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadAdminReports() {
            const today = new Date();
            const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Calculate revenues from service records (more accurate)
            const todayRevenue = serviceRecords
                .filter(s => {
                    const serviceDate = new Date(s.date);
                    return serviceDate.toDateString() === today.toDateString();
                })
                .reduce((total, s) => total + (s.price || 0), 0);
            
            const monthRevenue = serviceRecords
                .filter(s => {
                    const serviceDate = new Date(s.date);
                    return serviceDate >= thisMonth && serviceDate <= today;
                })
                .reduce((total, s) => total + (s.price || 0), 0);
            
            const totalRevenue = calculateTotalRevenue();
            
            // Calculate average daily revenue based on days with services
            const serviceDays = new Set(serviceRecords.map(s => new Date(s.date).toDateString())).size;
            const avgDailyRevenue = serviceDays > 0 ? Math.floor(totalRevenue / serviceDays) : 0;
            
            // Update revenue stats
            document.getElementById('admin-today-revenue').textContent = todayRevenue.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
            document.getElementById('admin-month-revenue').textContent = monthRevenue.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
            document.getElementById('admin-avg-daily-revenue').textContent = avgDailyRevenue.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
            
            // Calculate customer stats
            const newCustomersThisMonth = customers.filter(c => new Date(c.createdAt) >= thisMonth).length;
            const activeCustomers = customers.filter(c => (c.visits || 0) > 0).length;
            const avgVisits = customers.length > 0 ? Math.floor(customers.reduce((total, c) => total + (c.visits || 0), 0) / customers.length) : 0;
            
            document.getElementById('admin-new-customers-month').textContent = newCustomersThisMonth;
            document.getElementById('admin-active-customers').textContent = activeCustomers;
            document.getElementById('admin-avg-visits').textContent = avgVisits;
            
            // Load top customers
            loadAdminTopCustomers();
        }

        function loadAdminTopCustomers() {
            const topCustomers = customers
                .sort((a, b) => (b.visits || 0) - (a.visits || 0))
                .slice(0, 5);
            
            const container = document.getElementById('admin-top-customers');
            
            if (topCustomers.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</div>';
                return;
            }
            
            container.innerHTML = topCustomers.map((customer, index) => `
                <div class="flex items-center justify-between p-4 bg-white bg-opacity-30 rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full gradient-btn flex items-center justify-center text-white font-bold">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium">${customer.name}</div>
                            <div class="text-sm text-gray-600">${customer.visits || 0} Ø¬Ù„Ø³Ù‡</div>
                        </div>
                    </div>
                    <div class="text-left">
                        <div class="font-bold">${(customer.balance || 0).toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                    </div>
                </div>
            `).join('');
        }

        // Cashback functions
        function loadAdminLoyalty() {
            const baseCashback = localStorage.getItem('base-cashback') || '5';
            const visit3Bonus = localStorage.getItem('visit3-bonus') || '3';
            const visit5Bonus = localStorage.getItem('visit5-bonus') || '5';
            const visit10Bonus = localStorage.getItem('visit10-bonus') || '10';
            const referralCount = localStorage.getItem('referral-count') || '3';
            
            document.getElementById('admin-base-cashback').value = baseCashback;
            document.getElementById('admin-visit3-bonus').value = visit3Bonus;
            document.getElementById('admin-visit5-bonus').value = visit5Bonus;
            document.getElementById('admin-visit10-bonus').value = visit10Bonus;
            document.getElementById('admin-referral-count').value = referralCount;
            
            loadAdminActiveCampaigns();
        }

        function saveCashbackSettings() {
            const baseCashback = document.getElementById('admin-base-cashback').value;
            const visit3Bonus = document.getElementById('admin-visit3-bonus').value;
            const visit5Bonus = document.getElementById('admin-visit5-bonus').value;
            const visit10Bonus = document.getElementById('admin-visit10-bonus').value;
            const referralCount = document.getElementById('admin-referral-count').value;
            
            localStorage.setItem('base-cashback', baseCashback);
            localStorage.setItem('visit3-bonus', visit3Bonus);
            localStorage.setItem('visit5-bonus', visit5Bonus);
            localStorage.setItem('visit10-bonus', visit10Bonus);
            localStorage.setItem('referral-count', referralCount);
            
            showNotification('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯! ğŸ’°', 'success');
        }

        function calculateCashback(customerId, amount) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return 0;
            
            const baseCashback = parseInt(localStorage.getItem('base-cashback') || '5');
            const visit3Bonus = parseInt(localStorage.getItem('visit3-bonus') || '3');
            const visit5Bonus = parseInt(localStorage.getItem('visit5-bonus') || '5');
            const visit10Bonus = parseInt(localStorage.getItem('visit10-bonus') || '10');
            
            let totalCashbackPercent = baseCashback;
            const visits = customer.visits || 0;
            
            if (visits >= 10) {
                totalCashbackPercent += visit10Bonus;
            } else if (visits >= 5) {
                totalCashbackPercent += visit5Bonus;
            } else if (visits >= 3) {
                totalCashbackPercent += visit3Bonus;
            }
            
            return Math.floor((amount * totalCashbackPercent) / 100);
        }

        function createAdminCampaign() {
            const name = document.getElementById('admin-campaign-name').value.trim();
            const discount = document.getElementById('admin-campaign-discount').value;
            const persianExpiry = document.getElementById('admin-campaign-expiry').value;
            const description = document.getElementById('admin-campaign-description').value.trim();
            
            if (!name || !discount || !persianExpiry) {
                showNotification('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            // Validate Persian date format
            if (!/^\d{4}\/\d{2}\/\d{2}$/.test(persianExpiry)) {
                showNotification('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø¨Ù‡ ÙØ±Ù…Øª ØµØ­ÛŒØ­ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 1403/10/15)', 'error');
                return;
            }
            
            // Convert Persian date to Gregorian for storage
            const gregorianExpiry = convertPersianToGregorian(persianExpiry, '23:59');
            
            const campaign = {
                id: Date.now().toString(),
                name,
                discount: parseInt(discount),
                expiry: gregorianExpiry.toISOString(),
                persianExpiry: persianExpiry,
                description,
                createdAt: new Date().toISOString(),
                active: true
            };
            
            campaigns.push(campaign);
            localStorage.setItem('nail-salon-campaigns', JSON.stringify(campaigns));
            
            // Clear form
            document.getElementById('admin-campaign-name').value = '';
            document.getElementById('admin-campaign-discount').value = '';
            document.getElementById('admin-campaign-expiry').value = '';
            document.getElementById('admin-campaign-description').value = '';
            
            loadAdminActiveCampaigns();
            showNotification('Ú©Ù…Ù¾ÛŒÙ† Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯! ğŸ¯', 'success');
        }

        function loadAdminActiveCampaigns() {
            const container = document.getElementById('admin-active-campaigns');
            const activeCampaigns = campaigns.filter(c => c.active && new Date(c.expiry) > new Date());
            
            if (activeCampaigns.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Ù‡Ù†ÙˆØ² Ú©Ù…Ù¾ÛŒÙ†ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸ</div>';
                return;
            }
            
            container.innerHTML = activeCampaigns.map(campaign => {
                const displayDate = campaign.persianExpiry || new Date(campaign.expiry).toLocaleDateString('fa-IR');
                
                return `
                    <div class="customer-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h4 class="font-bold text-gray-800">${campaign.name}</h4>
                                <p class="text-sm text-gray-600">${campaign.discount}% ØªØ®ÙÛŒÙ</p>
                            </div>
                            <div class="badge">${displayDate}</div>
                        </div>
                        
                        ${campaign.description ? `
                            <p class="text-gray-700 mb-4">${campaign.description}</p>
                        ` : ''}
                        
                        <div class="flex gap-2">
                            <button onclick="sendAdminCampaignMessage('${campaign.id}')" class="gradient-btn text-white px-4 py-2 rounded-lg text-sm flex-1">
                                ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡
                            </button>
                            <button onclick="deactivateAdminCampaign('${campaign.id}')" class="bg-red-400 text-white px-4 py-2 rounded-lg text-sm">
                                âŒ ØºÛŒØ±ÙØ¹Ø§Ù„
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function sendAdminCampaignMessage(campaignId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (campaign) {
                showNotification(`Ú©Ù…Ù¾ÛŒÙ† "${campaign.name}" Ø¨Ø±Ø§ÛŒ ${customers.length} Ù…Ø´ØªØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯! ğŸ¯`, 'success');
            }
        }

        function deactivateAdminCampaign(campaignId) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (campaign && confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ù…Ù¾ÛŒÙ† "${campaign.name}" Ø±Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯ØŸ`)) {
                campaign.active = false;
                localStorage.setItem('nail-salon-campaigns', JSON.stringify(campaigns));
                loadAdminActiveCampaigns();
                showNotification('Ú©Ù…Ù¾ÛŒÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯', 'success');
            }
        }

        // Settings functions
        function saveAdminSettings() {
            const salonName = document.getElementById('admin-salon-name').value.trim();
            const salonPhone = document.getElementById('admin-salon-phone').value.trim();
            const salonAddress = document.getElementById('admin-salon-address').value.trim();
            
            settings.salonName = salonName;
            settings.salonPhone = salonPhone;
            settings.salonAddress = salonAddress;
            
            localStorage.setItem('nail-salon-settings', JSON.stringify(settings));
            showNotification('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯! âš™ï¸', 'success');
        }

        function backupData() {
            const data = {
                customers,
                appointments,
                settings,
                campaigns,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nail-salon-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! ğŸ’¾', 'success');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ØŸ')) {
                                customers = data.customers || [];
                                appointments = data.appointments || [];
                                settings = data.settings || {};
                                campaigns = data.campaigns || [];
                                
                                localStorage.setItem('nail-salon-customers', JSON.stringify(customers));
                                localStorage.setItem('nail-salon-appointments', JSON.stringify(appointments));
                                localStorage.setItem('nail-salon-settings', JSON.stringify(settings));
                                localStorage.setItem('nail-salon-campaigns', JSON.stringify(campaigns));
                                
                                location.reload();
                            }
                        } catch (error) {
                            showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: Ø§ÛŒÙ† Ø¹Ù…Ù„ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª. Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                if (confirm('Ø¢ÛŒØ§ ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ù…Ø´ØªØ±ÛŒØ§Ù†ØŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯!')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        function exportData() {
            const data = customers.map(customer => ({
                'Ù†Ø§Ù…': customer.name,
                'Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³': customer.phone,
                'ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯': customer.birthday || '',
                'ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª': customer.visits || 0,
                'Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨': customer.balance || 0,
                'ÙˆØ¶Ø¹ÛŒØª': getStatusText(customer.status)
            }));
            
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customers-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('ÙØ§ÛŒÙ„ Excel Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯! ğŸ“Š', 'success');
        }

        function convertToCSV(data) {
            if (!data.length) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            return '\uFEFF' + csvContent; // Add BOM for proper UTF-8 encoding
        }

        function showAddServiceModal() {
            // Populate customer dropdown
            const customerSelect = document.getElementById('service-customer-select');
            customerSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ...</option>' + 
                customers.map(customer => `<option value="${customer.id}">${customer.name} - ${customer.phone}</option>`).join('');
            
            document.getElementById('add-service-modal').classList.remove('hidden');
            document.getElementById('add-service-modal').classList.add('flex');
        }

        function toggleCustomServiceType() {
            const serviceType = document.getElementById('service-type-select').value;
            const customTypeInput = document.getElementById('service-custom-type');
            
            if (serviceType === 'other') {
                customTypeInput.classList.remove('hidden');
            } else {
                customTypeInput.classList.add('hidden');
                customTypeInput.value = '';
            }
        }

        function formatPersianDate(input) {
            let value = input.value.replace(/[^\d]/g, '');
            
            if (value.length >= 4) {
                value = value.substring(0, 4) + '/' + value.substring(4);
            }
            if (value.length >= 7) {
                value = value.substring(0, 7) + '/' + value.substring(7);
            }
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            
            input.value = value;
        }

        function convertPersianToGregorian(persianDate, time) {
            // Simple conversion - in real app you'd use a proper Persian calendar library
            const parts = persianDate.split('/');
            if (parts.length !== 3) return new Date();
            
            const persianYear = parseInt(parts[0]);
            const persianMonth = parseInt(parts[1]);
            const persianDay = parseInt(parts[2]);
            
            // Approximate conversion (for demo purposes)
            const gregorianYear = persianYear + 621;
            const gregorianMonth = persianMonth;
            const gregorianDay = persianDay;
            
            const [hours, minutes] = time.split(':');
            const date = new Date(gregorianYear, gregorianMonth - 1, gregorianDay, parseInt(hours), parseInt(minutes));
            
            return date;
        }

        function convertGregorianToPersian(gregorianDate) {
            // Simple conversion - in real app you'd use a proper Persian calendar library
            const year = gregorianDate.getFullYear() - 621;
            const month = gregorianDate.getMonth() + 1;
            const day = gregorianDate.getDate();
            
            return `${year}/${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
        }

        function addServiceRecord() {
            const customerId = document.getElementById('service-customer-select').value;
            const serviceType = document.getElementById('service-type-select').value;
            const customServiceType = document.getElementById('service-custom-type').value.trim();
            const price = document.getElementById('service-price').value;
            const description = document.getElementById('service-description').value.trim();
            
            if (!customerId || !serviceType || !price || !description) {
                showNotification('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            if (serviceType === 'other' && !customServiceType) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ø®Ø¯Ù…Øª Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            const servicePrice = parseInt(price);
            const cashback = calculateCashback(customerId, servicePrice);
            
            const serviceRecord = {
                id: Date.now().toString(),
                customerId,
                serviceType,
                customServiceType: serviceType === 'other' ? customServiceType : '',
                price: servicePrice,
                cashback: cashback,
                description,
                date: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };
            
            serviceRecords.push(serviceRecord);
            localStorage.setItem('nail-salon-service-records', JSON.stringify(serviceRecords));
            
            // Update customer stats and add cashback
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                customer.visits = (customer.visits || 0) + 1;
                customer.balance = (customer.balance || 0) + cashback;
                localStorage.setItem('nail-salon-customers', JSON.stringify(customers));
            }
            
            // Clear form
            document.getElementById('service-customer-select').value = '';
            document.getElementById('service-type-select').value = 'manicure';
            document.getElementById('service-custom-type').value = '';
            document.getElementById('service-custom-type').classList.add('hidden');
            document.getElementById('service-price').value = '';
            document.getElementById('service-description').value = '';
            
            closeModal('add-service-modal');
            loadAdminServices();
            updateAdminStats();
            showNotification(`Ø³Ø§Ø¨Ù‚Ù‡ Ø®Ø¯Ù…Øª Ø«Ø¨Øª Ø´Ø¯! ${cashback.toLocaleString()} ØªÙˆÙ…Ø§Ù† Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯! ğŸ’°`, 'success');
        }

        // Utility functions
        function calculateTotalRevenue() {
            // Calculate from service records (most accurate)
            return serviceRecords.reduce((total, service) => {
                return total + (service.price || 0);
            }, 0);
        }

        function getTodayAppointments() {
            const today = new Date().toDateString();
            return appointments.filter(appointment => 
                new Date(appointment.datetime).toDateString() === today
            );
        }

        function getVIPCustomers() {
            return customers.filter(customer => (customer.visits || 0) >= 10);
        }



        function getStatusText(status) {
            const statusTexts = {
                'new': 'Ø¬Ø¯ÛŒØ¯',
                'loyal': 'ÙˆÙØ§Ø¯Ø§Ø±',
                'vip': 'VIP',
                'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±',
                'confirmed': 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
                'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
                'cancelled': 'Ù„ØºÙˆ Ø´Ø¯Ù‡'
            };
            return statusTexts[status] || status;
        }

        function getServiceName(service) {
            const serviceNames = {
                'manicure': 'Ù…Ø§Ù†ÛŒÚ©ÙˆØ±',
                'laminate': 'Ø§Ø³ØªØ­Ú©Ø§Ù… Ø³Ø§Ø²ÛŒ Ù†Ø§Ø®Ù† Ø·Ø¨ÛŒØ¹ÛŒ (Ù„Ù…ÛŒÙ†Øª)',
                'initial-extension': 'Ú©Ø§Ø´Øª Ø§ÙˆÙ„ÛŒÙ‡',
                'repair': 'ØªØ±Ù…ÛŒÙ…',
                'colleague-repair': 'ØªØ±Ù…ÛŒÙ… Ù‡Ù…Ú©Ø§Ø±',
                'gel-polish': 'Ú˜Ù„ Ù¾ÙˆÙ„ÛŒØ´ Ø¯Ø³Øª',
                'shape-fix': 'Ø§ØµÙ„Ø§Ø­ ÙØ±Ù… Ùˆ Ù†Ø§Ø®Ù† Ø´Ú©Ø³ØªÙ‡'
            };
            return serviceNames[service] || service;
        }

        function getAdditionalServiceName(service) {
            const additionalServiceNames = {
                'french': 'ÙØ±Ù†Ú†',
                'ombre': 'Ø¢Ù…Ø¨Ø±Ù‡',
                'galaxy-gel': 'Ù„Ø§Ú© Ú˜Ù„ Ú©Ù‡Ú©Ø´Ø§Ù†ÛŒ',
                'lens-chrome': 'Ø¯ÛŒØ²Ø§ÛŒÙ† Ù„Ù†Ø² Ùˆ Ú©Ø±ÙˆÙ…'
            };
            return additionalServiceNames[service] || service;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-2xl text-white font-medium transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-gradient-to-r from-green-400 to-green-500' : 
                type === 'error' ? 'bg-gradient-to-r from-red-400 to-red-500' : 
                'bg-gradient-to-r from-blue-400 to-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.add('hidden');
                e.target.classList.remove('flex');
            }
        });

        // Search functionality for admin
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('admin-customer-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterAdminCustomers(this.value);
                });
            }
        });

        function filterAdminCustomers(searchTerm) {
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                customer.phone.includes(searchTerm)
            );
            
            const container = document.getElementById('admin-customers-list');
            
            if (filteredCustomers.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Ù…Ø´ØªØ±ÛŒâ€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ ğŸ”</div>';
                return;
            }
            
            container.innerHTML = filteredCustomers.map(customer => `
                <div class="customer-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full gradient-btn flex items-center justify-center text-white text-xl">
                                ${customer.name.charAt(0)}
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">${customer.name}</div>
                                <div class="text-sm text-gray-600">${customer.phone}</div>
                            </div>
                        </div>
                        <div class="badge ${customer.status}">${getStatusText(customer.status)}</div>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span>Ù…Ø±Ø§Ø¬Ø¹Ø§Øª:</span>
                            <span class="font-medium">${customer.visits || 0} Ø¨Ø§Ø±</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Ø´Ø§Ø±Ú˜:</span>
                            <span class="font-medium">${(customer.balance || 0).toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                    </div>
                    
                    <button onclick="openCustomerPanel('${customer.id}')" class="gradient-btn text-white px-4 py-2 rounded-xl w-full">
                        ğŸ‘¤ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ù†Ù„ Ù…Ø´ØªØ±ÛŒ
                    </button>
                </div>
            `).join('');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f2d056868a9c0d',t:'MTc2MDU2Nzk4MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { setLogLevel, initializeFirestore, getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, query, where, onSnapshot, updateDoc, serverTimestamp, orderBy, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // === Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù† Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Firebase Ø®ÙˆØ¯Øª ===
  const firebaseConfig = {
  apiKey: "AIzaSyBYf7X33Cof8IM0uH0Set8Ev1EfAIE4SJ8",
  authDomain: "nasrynnail-crm-f6f80.firebaseapp.com",
  projectId: "nasrynnail-crm-f6f80",
  storageBucket: "nasrynnail-crm-f6f80.appspot.com",
  messagingSenderId: "398579445205",
  appId: "1:398579445205:web:185295d6c9296f4c9ca15c"
};

  const app = initializeApp(firebaseConfig);
  const db = initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });
  setLogLevel('error');
  const auth = getAuth(app);

  // ---- Helpers ----
  async function fbFindCustomerByPhone(phone) {
    const q = query(collection(db, "customers"), where("phone", "==", phone));
    const s = await getDocs(q);
    if (s.empty) return null;
    const d = s.docs[0]; return { id: d.id, ...d.data() };
  }

  async function fbAddCustomer({name, phone, birthday}) {
    if (await fbFindCustomerByPhone(phone)) throw new Error("Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.");
    const ref = await addDoc(collection(db, "customers"), {
      name, phone, birthday: birthday || null,
      visits: 0, balance: 30000, createdAt: serverTimestamp()
    });
    const snap = await getDoc(ref);
    return { id: ref.id, ...snap.data() };
  }

  async function fbAddAppointment(appt) {
    await addDoc(collection(db, "appointments"), { ...appt, createdAt: serverTimestamp() });
  }

  async function fbCancelAppointment(apptId, {reason, suggestedDate, suggestedTime} = {}) {
    const updates = { status: "cancelled" };
    if (reason) updates.cancelReason = reason;
    if (suggestedDate) updates.suggestedDate = suggestedDate;
    if (suggestedTime) updates.suggestedTime = suggestedTime;
    await updateDoc(doc(db, "appointments", apptId), updates);
  }

  async function fbAddServiceRecord({ customerId, serviceType, customServiceType, price, description, cashback, date }) {
    await addDoc(collection(db, "serviceRecords"), {
      customerId, serviceType, customServiceType: customServiceType || null,
      price: Number(price), description: description || "", cashback: Number(cashback || 0),
      date, createdAt: serverTimestamp()
    });
    await updateDoc(doc(db, "customers", customerId), {
      balance: increment(Number(cashback || 0)),
      visits: increment(1)
    });
  }

  async function fbSaveSettings(settingsObj) {
    await setDoc(doc(db, "settings", "main"), { ...settingsObj, updatedAt: serverTimestamp() });
  }

  async function fbReadSettings() {
    const s = await getDoc(doc(db, "settings", "main"));
    return s.exists() ? s.data() : {};
  }

  async function fbAdminLogin(email, password) {
    await signInWithEmailAndPassword(auth, email, password);
    return auth.currentUser;
  }
  async function fbAdminLogout() { await signOut(auth); }

  function fbWatchAll() {
    const u1 = onSnapshot(query(collection(db, "customers"), orderBy("createdAt","desc")), (snap) => {
      window.customers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.loadAdminCustomers?.();
      if (window.userType === 'customer' && window.currentUser) {
        const me = window.customers.find(c => c.id === window.currentUser.id || c.phone === window.currentUser.phone);
        if (me) { window.currentUser = { ...me }; window.loadCustomerData?.(); }
      }
      window.updateAdminStats?.();
    });
    const u2 = onSnapshot(query(collection(db, "appointments"), orderBy("datetime","desc")), (snap) => {
      window.appointments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.loadCustomerAppointments?.();
      window.loadCustomerRecentAppointments?.();
      window.loadAdminAppointments?.();
      window.updateAdminStats?.();
    });
    const u3 = onSnapshot(collection(db, "campaigns"), (snap) => {
      window.campaigns = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.loadCustomerCampaigns?.();
      window.loadAdminCampaigns?.();
    });
    const u4 = onSnapshot(collection(db, "serviceRecords"), (snap) => {
      window.serviceRecords = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.loadCustomerServiceHistory?.();
      window.loadAdminServices?.();
      window.updateAdminStats?.();
    });
    const u5 = onSnapshot(doc(db, "settings", "main"), (snap) => {
      window.settings = snap.exists() ? snap.data() : {};
      window.loadSettingsForm?.();
    });
    return () => { u1(); u2(); u3(); u4(); u5(); };
  }

  window.fb = {
    db, auth,
    findCustomerByPhone: fbFindCustomerByPhone,
    addCustomer: fbAddCustomer,
    addAppointment: fbAddAppointment,
    cancelAppointment: fbCancelAppointment,
    addServiceRecord: fbAddServiceRecord,
    saveSettings: fbSaveSettings,
    readSettings: fbReadSettings,
    adminLogin: fbAdminLogin,
    adminLogout: fbAdminLogout,
    watchAll: fbWatchAll,
  };

  // Start realtime listeners
  window.fb.watchAll();

  // Keep UI in sync with auth for admin
  onAuthStateChanged(auth, (user) => {
    if (user && window.userType === 'admin') {
      window.showAdminPanel?.();
    }
  });
</script>

<script>
// ==== Overrides to switch logic from localStorage to Firestore ====

// Customer login by phone
function customerLogin() {
  const phone = document.getElementById('customer-login-phone').value.trim();
  if (!phone) { showNotification('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }
  (async () => {
    const customer = await window.fb.findCustomerByPhone(phone);
    if (!customer) { showNotification('Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯', 'error'); return; }
    window.currentUser = customer;
    window.userType = 'customer';
    showCustomerPanel();
    showNotification(`Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${customer.name}! ğŸŒ¸`, 'success');
  })().catch(e => showNotification(e.message || 'Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯', 'error'));
}

// Customer register
function customerRegister() {
  const name = document.getElementById('customer-register-name').value.trim();
  const phone = document.getElementById('customer-register-phone').value.trim();
  const birthday = document.getElementById('customer-register-birthday').value;
  if (!name || !phone) { showNotification('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }
  (async () => {
    const newCustomer = await window.fb.addCustomer({ name, phone, birthday });
    window.currentUser = newCustomer;
    window.userType = 'customer';
    showCustomerPanel();
    showNotification(`Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${newCustomer.name}! ğŸ‰ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø§ Û³Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† Ø´Ø§Ø±Ú˜ Ø´Ø¯! ğŸ’°`, 'success');
  })().catch(e => showNotification(e.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…', 'error'));
}

// Admin login (using Firebase Auth)
function adminLogin() {
  const email = document.getElementById('admin-username').value.trim();
  const password = document.getElementById('admin-password').value.trim();
  (async () => {
    await window.fb.adminLogin(email, password);
    window.userType = 'admin';
    showAdminPanel();
    showNotification('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª! âš™ï¸', 'success');
  })().catch(() => showNotification('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error'));
}

// Logout (also signs out admin if logged in)
async function logout() {
  try { await window.fb.adminLogout?.(); } catch(e) {}
  currentUser = null;
  userType = null;
  showAuthScreen();
  document.getElementById('customer-login-phone').value = '';
  document.getElementById('customer-register-name').value = '';
  document.getElementById('customer-register-phone').value = '';
  document.getElementById('customer-register-birthday').value = '';
  document.getElementById('admin-username').value = '';
  document.getElementById('admin-password').value = '';
  showNotification('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚! ğŸ‘‹', 'success');
}

// Book appointment override (if original exists, this one takes precedence)
async function bookAppointment() {
  if (!window.currentUser) { showNotification('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'error'); return; }
  const date = document.getElementById('book-appointment-date').value;
  const time = document.getElementById('book-appointment-time').value;
  const service = document.getElementById('book-appointment-service').value;
  const notes = document.getElementById('book-appointment-notes').value.trim();

  const additionalServices = [];
  if (document.getElementById('additional-french')?.checked) additionalServices.push('french');
  if (document.getElementById('additional-ombre')?.checked) additionalServices.push('ombre');
  if (document.getElementById('additional-galaxy')?.checked) additionalServices.push('galaxy-gel');
  if (document.getElementById('additional-lens')?.checked) additionalServices.push('lens-chrome');

  if (!date || !time) { showNotification('ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }

  const iso = (() => {
    try {
      const [y,m,d] = date.split('/').map(Number);
      const [hh,mm] = time.split(':').map(Number);
      // Assume Jalali input; if your date is Gregorian, adjust accordingly
      // For simplicity, store as string combination
      return new Date().toISOString();
    } catch { return new Date().toISOString(); }
  })();

  const appointment = {
    id: crypto.randomUUID(),
    customerId: window.currentUser.id,
    service, additionalServices, notes,
    status: 'pending',
    datetime: iso,
    persianDate: date,
    persianTime: time,
    createdAt: new Date().toISOString()
  };

  try {
    await window.fb.addAppointment(appointment);
    closeModal('book-appointment-modal');
    showNotification('Ù†ÙˆØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ…', 'success');
  } catch (e) {
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†ÙˆØ¨Øª', 'error');
  }
}

// Cancel appointment (customer)
function cancelCustomerAppointment(apptId) {
  // Open cancel modal as existing UI does
  window._cancelApptId = apptId;
  openModal?.('cancel-appointment-modal');
}

async function confirmCancelAppointment() {
  const reason = document.getElementById('cancel-reason').value.trim();
  const suggestedDate = document.getElementById('suggested-date').value;
  const suggestedTime = document.getElementById('suggested-time').value;
  if (!window._cancelApptId) return;
  try {
    await window.fb.cancelAppointment(window._cancelApptId, {reason, suggestedDate, suggestedTime});
    closeModal('cancel-appointment-modal');
    showNotification('Ù†ÙˆØ¨Øª Ù„ØºÙˆ Ø´Ø¯ âŒ', 'success');
  } catch (e) {
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù†ÙˆØ¨Øª', 'error');
  } finally {
    window._cancelApptId = null;
  }
}

// Add service record (admin)
async function addServiceRecord() {
  const customerId = document.getElementById('service-customer-select').value;
  const serviceType = document.getElementById('service-type-select').value;
  const customServiceType = document.getElementById('service-custom-type').value.trim();
  const price = parseInt(document.getElementById('service-price').value || '0', 10);
  const description = document.getElementById('service-description').value.trim();
  if (!customerId || !serviceType || !price) { showNotification('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø¯Ù…Øª Ù†Ø§Ù‚Øµ Ø§Ø³Øª', 'error'); return; }
  const cashbackPercent = parseInt(localStorage.getItem('base-cashback') || '5', 10);
  const cashback = Math.floor((price * cashbackPercent) / 100);
  try {
    await window.fb.addServiceRecord({
      customerId, serviceType, customServiceType,
      price, description, cashback, date: new Date().toISOString()
    });
    closeModal('add-service-modal');
    showNotification('Ø«Ø¨Øª Ø®Ø¯Ù…Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ ğŸ’…âœ…', 'success');
  } catch(e) {
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø®Ø¯Ù…Øª', 'error');
  }
}

// Modal add service (admin/customer panel modal)
async function addModalServiceRecord() {
  const price = parseInt(document.getElementById('modal-service-price').value || '0', 10);
  const serviceType = document.getElementById('modal-service-type').value;
  const customServiceType = document.getElementById('modal-custom-type').value.trim();
  const description = document.getElementById('modal-service-description').value.trim();
  const customerId = (window._modalCustomerId) || (window.currentUser?.id);
  if (!customerId) { showNotification('Ù…Ø´ØªØ±ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø§Ø³Øª', 'error'); return; }
  const cashbackPercent = parseInt(localStorage.getItem('base-cashback') || '5', 10);
  const cashback = Math.floor((price * cashbackPercent) / 100);
  try {
    await window.fb.addServiceRecord({
      customerId, serviceType, customServiceType,
      price, description, cashback, date: new Date().toISOString()
    });
    showNotification('Ø«Ø¨Øª Ø®Ø¯Ù…Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ ğŸ’…âœ…', 'success');
  } catch(e) {
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø®Ø¯Ù…Øª', 'error');
  }
}

// Save settings to Firestore
async function saveAdminSettings() {
  const salonName = document.getElementById('admin-salon-name').value.trim();
  const salonPhone = document.getElementById('admin-salon-phone').value.trim();
  const salonAddress = document.getElementById('admin-salon-address').value.trim();
  const loyaltyPercent = parseInt(document.getElementById('admin-loyalty-percentage')?.value || '5', 10);
  const referralCount = parseInt(document.getElementById('admin-referral-count')?.value || '3', 10);
  const obj = { salonName, salonPhone, salonAddress, loyaltyPercent, referralCount };
  try {
    await window.fb.saveSettings(obj);
    showNotification('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…', 'success');
  } catch(e) {
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'error');
  }
}
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { setLogLevel, initializeFirestore, getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, query, where, onSnapshot, updateDoc, serverTimestamp, orderBy, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
  apiKey: "AIzaSyBYf7X33Cof8IM0uH0Set8Ev1EfAIE4SJ8",
  authDomain: "nasrynnail-crm-f6f80.firebaseapp.com",
  projectId: "nasrynnail-crm-f6f80",
  storageBucket: "nasrynnail-crm-f6f80.appspot.com",
  messagingSenderId: "398579445205",
  appId: "1:398579445205:web:185295d6c9296f4c9ca15c"
};

  const app = initializeApp(firebaseConfig);
  const db = initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });
  setLogLevel('error');
  const auth = getAuth(app);

  async function fbFindCustomerByPhone(phone) {
    const q = query(collection(db, "customers"), where("phone", "==", phone));
    const s = await getDocs(q);
    if (s.empty) return null;
    const d = s.docs[0]; return { id: d.id, ...d.data() };
  }

  async function fbAddCustomer({name, phone, birthday}) {
    if (await fbFindCustomerByPhone(phone)) throw new Error("Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.");
    const ref = await addDoc(collection(db, "customers"), {
      name, phone, birthday: birthday || null,
      visits: 0, balance: 30000, createdAt: serverTimestamp()
    });
    const snap = await getDoc(ref);
    return { id: ref.id, ...snap.data() };
  }

  async function fbAddAppointment(appt) {
    await addDoc(collection(db, "appointments"), { ...appt, createdAt: serverTimestamp() });
  }

  async function fbCancelAppointment(apptId, {reason, suggestedDate, suggestedTime} = {}) {
    const updates = { status: "cancelled" };
    if (reason) updates.cancelReason = reason;
    if (suggestedDate) updates.suggestedDate = suggestedDate;
    if (suggestedTime) updates.suggestedTime = suggestedTime;
    await updateDoc(doc(db, "appointments", apptId), updates);
  }

  async function fbAddServiceRecord({ customerId, serviceType, customServiceType, price, description, cashback, date }) {
    await addDoc(collection(db, "serviceRecords"), {
      customerId, serviceType, customServiceType: customServiceType || null,
      price: Number(price), description: description || "", cashback: Number(cashback || 0),
      date, createdAt: serverTimestamp()
    });
    await updateDoc(doc(db, "customers", customerId), {
      balance: increment(Number(cashback || 0)),
      visits: increment(1)
    });
  }

  async function fbSaveSettings(settingsObj) {
    await setDoc(doc(db, "settings", "main"), { ...settingsObj, updatedAt: serverTimestamp() });
  }

  async function fbReadSettings() {
    const s = await getDoc(doc(db, "settings", "main"));
    return s.exists() ? s.data() : {};
  }

  async function fbAdminLogin(email, password) {
    await signInWithEmailAndPassword(auth, email, password);
    return auth.currentUser;
  }
  async function fbAdminLogout() { await signOut(auth); }

  function fbWatchAll() {
    const u1 = onSnapshot(query(collection(db, "customers"), orderBy("createdAt","desc")), (snap) => {
      window.customers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.loadAdminCustomers?.();
      if (window.userType === 'customer' && window.currentUser) {
        const me = window.customers.find(c => c.id === window.currentUser.id || c.phone === window.currentUser.phone);
        if (me) { window.currentUser = { ...me }; window.loadCustomerProfile?.(); }
      }
      window.updateAdminStats?.();
    });
    const u2 = onSnapshot(query(collection(db, "appointments"), orderBy("datetime","desc")), (snap) => {
      window.appointments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.loadCustomerAppointments?.();
      window.loadCustomerRecentAppointments?.();
      window.loadAdminAppointments?.();
      window.updateAdminStats?.();
    });
    const u3 = onSnapshot(collection(db, "campaigns"), (snap) => {
      window.campaigns = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.loadCustomerCampaigns?.();
      window.loadAdminCampaigns?.();
    });
    const u4 = onSnapshot(collection(db, "serviceRecords"), (snap) => {
      window.serviceRecords = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.loadCustomerServiceHistory?.();
      window.loadAdminServices?.();
      window.updateAdminStats?.();
    });
    const u5 = onSnapshot(doc(db, "settings", "main"), (snap) => {
      window.settings = snap.exists() ? snap.data() : {};
      window.loadSettingsForm?.();
    });
    return () => { u1(); u2(); u3(); u4(); u5(); };
  }

  window.fb = {
    db, auth,
    findCustomerByPhone: fbFindCustomerByPhone,
    addCustomer: fbAddCustomer,
    addAppointment: fbAddAppointment,
    cancelAppointment: fbCancelAppointment,
    addServiceRecord: fbAddServiceRecord,
    saveSettings: fbSaveSettings,
    readSettings: fbReadSettings,
    adminLogin: fbAdminLogin,
    adminLogout: fbAdminLogout,
    watchAll: fbWatchAll,
  };

  window.fb.watchAll();
  onAuthStateChanged(auth, (user) => {
    if (user && window.userType === 'admin') {
      window.showAdminPanel?.();
    }
  });
</script>

<script>
function customerLogin() {
  const phone = document.getElementById('customer-login-phone').value.trim();
  if (!phone) { showNotification('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }
  (async () => {
    const customer = await window.fb.findCustomerByPhone(phone);
    if (!customer) { showNotification('Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯', 'error'); return; }
    window.currentUser = customer;
    window.userType = 'customer';
    showCustomerPanel();
    loadCustomerProfile?.();
    loadCustomerAppointments?.();
    loadCustomerRecentAppointments?.();
    loadCustomerCampaigns?.();
    loadCustomerServiceHistory?.();
    showNotification(`Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${customer.name}! ğŸŒ¸`, 'success');
  })().catch(e => showNotification(e.message || 'Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯', 'error'));
}

function customerRegister() {
  const name = document.getElementById('customer-register-name').value.trim();
  const phone = document.getElementById('customer-register-phone').value.trim();
  const birthday = document.getElementById('customer-register-birthday').value;
  if (!name || !phone) { showNotification('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }
  (async () => {
    const newCustomer = await window.fb.addCustomer({ name, phone, birthday });
    window.currentUser = newCustomer;
    window.userType = 'customer';
    showCustomerPanel();
    showNotification(`Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${newCustomer.name}! ğŸ‰ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø§ Û³Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† Ø´Ø§Ø±Ú˜ Ø´Ø¯! ğŸ’°`, 'success');
  })().catch(e => showNotification(e.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…', 'error'));
}

function adminLogin() {
  const email = document.getElementById('admin-username').value.trim();
  const password = document.getElementById('admin-password').value.trim();
  (async () => {
    await window.fb.adminLogin(email, password);
    window.userType = 'admin';
    showAdminPanel();
    showNotification('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª! âš™ï¸', 'success');
  })().catch(() => showNotification('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error'));
}

async function logout() {
  try { await window.fb.adminLogout?.(); } catch(e) {}
  currentUser = null;
  userType = null;
  showAuthScreen();
  document.getElementById('customer-login-phone').value = '';
  document.getElementById('customer-register-name').value = '';
  document.getElementById('customer-register-phone').value = '';
  document.getElementById('customer-register-birthday').value = '';
  document.getElementById('admin-username').value = '';
  document.getElementById('admin-password').value = '';
  showNotification('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚! ğŸ‘‹', 'success');
}

async function bookAppointment() {
  if (!window.currentUser) { showNotification('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'error'); return; }
  const date = document.getElementById('book-appointment-date').value;
  const time = document.getElementById('book-appointment-time').value;
  const service = document.getElementById('book-appointment-service').value;
  const notes = document.getElementById('book-appointment-notes').value.trim();

  const additionalServices = [];
  if (document.getElementById('additional-french')?.checked) additionalServices.push('french');
  if (document.getElementById('additional-ombre')?.checked) additionalServices.push('ombre');
  if (document.getElementById('additional-galaxy')?.checked) additionalServices.push('galaxy-gel');
  if (document.getElementById('additional-lens')?.checked) additionalServices.push('lens-chrome');

  if (!date || !time) { showNotification('ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }

  const appointment = {
    id: crypto.randomUUID(),
    customerId: window.currentUser.id,
    service, additionalServices, notes,
    status: 'pending',
    datetime: new Date().toISOString(),
    persianDate: date,
    persianTime: time,
    createdAt: new Date().toISOString()
  };

  try {
    await window.fb.addAppointment(appointment);
    closeModal?.('book-appointment-modal');
    showNotification('Ù†ÙˆØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ…', 'success');
  } catch (e) {
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†ÙˆØ¨Øª', 'error');
  }
}

function cancelCustomerAppointment(apptId) {
  window._cancelApptId = apptId;
  openModal?.('cancel-appointment-modal');
}
async function confirmCancelAppointment() {
  const reason = document.getElementById('cancel-reason').value.trim();
  const suggestedDate = document.getElementById('suggested-date').value;
  const suggestedTime = document.getElementById('suggested-time').value;
  if (!window._cancelApptId) return;
  try {
    await window.fb.cancelAppointment(window._cancelApptId, {reason, suggestedDate, suggestedTime});
    closeModal?.('cancel-appointment-modal');
    showNotification('Ù†ÙˆØ¨Øª Ù„ØºÙˆ Ø´Ø¯ âŒ', 'success');
  } catch (e) {
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù†ÙˆØ¨Øª', 'error');
  } finally {
    window._cancelApptId = null;
  }
}

async function addServiceRecord() {
  const customerId = document.getElementById('service-customer-select').value;
  const serviceType = document.getElementById('service-type-select').value;
  const customServiceType = document.getElementById('service-custom-type').value.trim();
  const price = parseInt(document.getElementById('service-price').value || '0', 10);
  const description = document.getElementById('service-description').value.trim();
  if (!customerId || !serviceType || !price) { showNotification('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø¯Ù…Øª Ù†Ø§Ù‚Øµ Ø§Ø³Øª', 'error'); return; }
  const cashbackPercent = parseInt(localStorage.getItem('base-cashback') || '5', 10);
  const cashback = Math.floor((price * cashbackPercent) / 100);
  try {
    await window.fb.addServiceRecord({
      customerId, serviceType, customServiceType,
      price, description, cashback, date: new Date().toISOString()
    });
    closeModal?.('add-service-modal');
    showNotification('Ø«Ø¨Øª Ø®Ø¯Ù…Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ ğŸ’…âœ…', 'success');
  } catch(e) {
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø®Ø¯Ù…Øª', 'error');
  }
}

async function saveAdminSettings() {
  const salonName = document.getElementById('admin-salon-name').value.trim();
  const salonPhone = document.getElementById('admin-salon-phone').value.trim();
  const salonAddress = document.getElementById('admin-salon-address').value.trim();
  const loyaltyPercent = parseInt(document.getElementById('admin-loyalty-percentage')?.value || '5', 10);
  const referralCount = parseInt(document.getElementById('admin-referral-count')?.value || '3', 10);
  const obj = { salonName, salonPhone, salonAddress, loyaltyPercent, referralCount };
  try {
    await window.fb.saveSettings(obj);
    showNotification('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…', 'success');
  } catch(e) {
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'error');
  }
}
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { setLogLevel, initializeFirestore, getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, query, where, onSnapshot, updateDoc, serverTimestamp, orderBy, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // === Firebase config: Nasryn Nail CRM ===
  const firebaseConfig = {
  apiKey: "AIzaSyBYf7X33Cof8IM0uH0Set8Ev1EfAIE4SJ8",
  authDomain: "nasrynnail-crm-f6f80.firebaseapp.com",
  projectId: "nasrynnail-crm-f6f80",
  storageBucket: "nasrynnail-crm-f6f80.appspot.com",
  messagingSenderId: "398579445205",
  appId: "1:398579445205:web:185295d6c9296f4c9ca15c"
};

  const app = initializeApp(firebaseConfig);
  const db = initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });
  setLogLevel('error');
  const auth = getAuth(app);

  // ---- Helpers ----
  async function fbFindCustomerByPhone(phone) {
    const q = query(collection(db, "customers"), where("phone", "==", phone));
    const s = await getDocs(q);
    if (s.empty) return null;
    const d = s.docs[0]; return { id: d.id, ...d.data() };
  }

  async function fbAddCustomer({name, phone, birthday}) {
    if (await fbFindCustomerByPhone(phone)) throw new Error("Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.");
    const ref = await addDoc(collection(db, "customers"), {
      name, phone, birthday: birthday || null,
      visits: 0, balance: 30000, createdAt: serverTimestamp()
    });
    const snap = await getDoc(ref);
    return { id: ref.id, ...snap.data() };
  }

  async function fbAddAppointment(appt) {
    await addDoc(collection(db, "appointments"), { ...appt, createdAt: serverTimestamp() });
  }

  async function fbCancelAppointment(apptId, {reason, suggestedDate, suggestedTime} = {}) {
    const updates = { status: "cancelled" };
    if (reason) updates.cancelReason = reason;
    if (suggestedDate) updates.suggestedDate = suggestedDate;
    if (suggestedTime) updates.suggestedTime = suggestedTime;
    await updateDoc(doc(db, "appointments", apptId), updates);
  }

  async function fbAddServiceRecord({ customerId, serviceType, customServiceType, price, description, cashback, date }) {
    await addDoc(collection(db, "serviceRecords"), {
      customerId, serviceType, customServiceType: customServiceType || null,
      price: Number(price), description: description || "", cashback: Number(cashback || 0),
      date, createdAt: serverTimestamp()
    });
    await updateDoc(doc(db, "customers", customerId), {
      balance: increment(Number(cashback || 0)),
      visits: increment(1)
    });
  }

  async function fbSaveSettings(settingsObj) {
    await setDoc(doc(db, "settings", "main"), { ...settingsObj, updatedAt: serverTimestamp() });
  }

  async function fbReadSettings() {
    const s = await getDoc(doc(db, "settings", "main"));
    return s.exists() ? s.data() : {};
  }

  async function fbAdminLogin(email, password) {
    await signInWithEmailAndPassword(auth, email, password);
    return auth.currentUser;
  }
  async function fbAdminLogout() { await signOut(auth); }

  // ---- Realtime listeners ----
  // Public reads (allowed by Rules): customers, appointments, campaigns, settings
  const unsubCustomers = onSnapshot(query(collection(db, "customers"), orderBy("createdAt","desc")), (snap) => {
    window.customers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    window.loadAdminCustomers?.();
    if (window.userType === 'customer' && window.currentUser) {
      const me = window.customers.find(c => c.id === window.currentUser.id || c.phone === window.currentUser.phone);
      if (me) { window.currentUser = { ...me }; window.loadCustomerProfile?.(); }
    }
    window.updateAdminStats?.();
  });

  const unsubAppointments = onSnapshot(query(collection(db, "appointments"), orderBy("datetime","desc")), (snap) => {
    window.appointments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    window.loadCustomerAppointments?.();
    window.loadCustomerRecentAppointments?.();
    window.loadAdminAppointments?.();
    window.updateAdminStats?.();
  });

  const unsubCampaigns = onSnapshot(collection(db, "campaigns"), (snap) => {
    window.campaigns = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    window.loadCustomerCampaigns?.();
    window.loadAdminCampaigns?.();
  });

  const unsubSettings = onSnapshot(doc(db, "settings", "main"), (snap) => {
    window.settings = snap.exists() ? snap.data() : {};
    window.loadSettingsForm?.();
  });

  // Admin-only listener (serviceRecords) to satisfy current Rules
  let _adminUnsubSR = null;
  function startAdminServiceRecords() {
    if (_adminUnsubSR) return;
    _adminUnsubSR = onSnapshot(collection(db, "serviceRecords"), (snap) => {
      window.serviceRecords = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.loadCustomerServiceHistory?.();
      window.loadAdminServices?.();
      window.updateAdminStats?.();
    });
  }
  function stopAdminServiceRecords() {
    if (_adminUnsubSR) { _adminUnsubSR(); _adminUnsubSR = null; }
    window.serviceRecords = [];
  }

  // Expose
  window.fb = {
    db, auth,
    findCustomerByPhone: fbFindCustomerByPhone,
    addCustomer: fbAddCustomer,
    addAppointment: fbAddAppointment,
    cancelAppointment: fbCancelAppointment,
    addServiceRecord: fbAddServiceRecord,
    saveSettings: fbSaveSettings,
    readSettings: fbReadSettings,
    adminLogin: fbAdminLogin,
    adminLogout: fbAdminLogout,
    startAdminServiceRecords, stopAdminServiceRecords
  };

  // Keep UI in sync with auth for admin
  onAuthStateChanged(auth, (user) => {
    if (user && window.userType === 'admin') {
      startAdminServiceRecords();
      window.showAdminPanel?.();
    } else {
      stopAdminServiceRecords();
    }
  });
</script>

<script>
function showNotification(msg, type='info'){ try{ 
  // Simple fallback toast
  console.log(type.toUpperCase()+':', msg);
} catch(e){} }

// --- Customer login by phone ---
function customerLogin() {
  const phone = document.getElementById('customer-login-phone').value.trim();
  if (!phone) { showNotification('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }
  (async () => {
    const customer = await window.fb.findCustomerByPhone(phone);
    if (!customer) { showNotification('Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯', 'error'); return; }
    window.currentUser = customer;
    window.userType = 'customer';
    showCustomerPanel();
    loadCustomerProfile?.();
    loadCustomerAppointments?.();
    loadCustomerRecentAppointments?.();
    loadCustomerCampaigns?.();
    loadCustomerServiceHistory?.();
    showNotification(`Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${customer.name}! ğŸŒ¸`, 'success');
  })().catch(e => showNotification(e.message || 'Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯', 'error'));
}

// --- Customer register ---
function customerRegister() {
  const name = document.getElementById('customer-register-name').value.trim();
  const phone = document.getElementById('customer-register-phone').value.trim();
  const birthday = document.getElementById('customer-register-birthday').value;
  if (!name || !phone) { showNotification('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }
  (async () => {
    const newCustomer = await window.fb.addCustomer({ name, phone, birthday });
    window.currentUser = newCustomer;
    window.userType = 'customer';
    showCustomerPanel();
    showNotification(`Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${newCustomer.name}! ğŸ‰ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø§ Û³Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† Ø´Ø§Ø±Ú˜ Ø´Ø¯! ğŸ’°`, 'success');
  })().catch(e => showNotification(e.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…', 'error'));
}

// --- Admin login via Firebase Auth ---
function adminLogin() {
  const email = document.getElementById('admin-username').value.trim();
  const password = document.getElementById('admin-password').value.trim();
  (async () => {
    await window.fb.adminLogin(email, password);
    window.userType = 'admin';
    window.fb.startAdminServiceRecords();
    showAdminPanel();
    showNotification('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª! âš™ï¸', 'success');
  })().catch((e) => {
    console.error(e);
    showNotification('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error');
  });
}

// --- Logout (also signs out admin) ---
async function logout() {
  try { await window.fb.adminLogout?.(); } catch(e) {}
  currentUser = null;
  userType = null;
  showAuthScreen();
  document.getElementById('customer-login-phone').value = '';
  document.getElementById('customer-register-name').value = '';
  document.getElementById('customer-register-phone').value = '';
  document.getElementById('customer-register-birthday').value = '';
  document.getElementById('admin-username').value = '';
  document.getElementById('admin-password').value = '';
  showNotification('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚! ğŸ‘‹', 'success');
}

// --- Book appointment ---
async function bookAppointment() {
  if (!window.currentUser) { showNotification('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'error'); return; }
  const date = document.getElementById('book-appointment-date').value;
  const time = document.getElementById('book-appointment-time').value;
  const service = document.getElementById('book-appointment-service').value;
  const notes = document.getElementById('book-appointment-notes').value.trim();

  const additionalServices = [];
  if (document.getElementById('additional-french')?.checked) additionalServices.push('french');
  if (document.getElementById('additional-ombre')?.checked) additionalServices.push('ombre');
  if (document.getElementById('additional-galaxy')?.checked) additionalServices.push('galaxy-gel');
  if (document.getElementById('additional-lens')?.checked) additionalServices.push('lens-chrome');

  if (!date || !time) { showNotification('ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error'); return; }

  const appointment = {
    id: crypto.randomUUID(),
    customerId: window.currentUser.id,
    service, additionalServices, notes,
    status: 'pending',
    datetime: new Date().toISOString(),
    persianDate: date,
    persianTime: time,
    createdAt: new Date().toISOString()
  };

  try {
    await window.fb.addAppointment(appointment);
    closeModal?.('book-appointment-modal');
    showNotification('Ù†ÙˆØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ…', 'success');
  } catch (e) {
    console.error(e);
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†ÙˆØ¨Øª', 'error');
  }
}

// --- Cancel appointment (customer) ---
function cancelCustomerAppointment(apptId) {
  window._cancelApptId = apptId;
  openModal?.('cancel-appointment-modal');
}
async function confirmCancelAppointment() {
  const reason = document.getElementById('cancel-reason').value.trim();
  const suggestedDate = document.getElementById('suggested-date').value;
  const suggestedTime = document.getElementById('suggested-time').value;
  if (!window._cancelApptId) return;
  try {
    await window.fb.cancelAppointment(window._cancelApptId, {reason, suggestedDate, suggestedTime});
    closeModal?.('cancel-appointment-modal');
    showNotification('Ù†ÙˆØ¨Øª Ù„ØºÙˆ Ø´Ø¯ âŒ', 'success');
  } catch (e) {
    console.error(e);
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù†ÙˆØ¨Øª', 'error');
  } finally {
    window._cancelApptId = null;
  }
}

// --- Add service record (admin) ---
async function addServiceRecord() {
  const customerId = document.getElementById('service-customer-select').value;
  const serviceType = document.getElementById('service-type-select').value;
  const customServiceType = document.getElementById('service-custom-type').value.trim();
  const price = parseInt(document.getElementById('service-price').value || '0', 10);
  const description = document.getElementById('service-description').value.trim();
  if (!customerId || !serviceType || !price) { showNotification('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø¯Ù…Øª Ù†Ø§Ù‚Øµ Ø§Ø³Øª', 'error'); return; }
  const cashbackPercent = parseInt(localStorage.getItem('base-cashback') || '5', 10);
  const cashback = Math.floor((price * cashbackPercent) / 100);
  try {
    await window.fb.addServiceRecord({
      customerId, serviceType, customServiceType,
      price, description, cashback, date: new Date().toISOString()
    });
    closeModal?.('add-service-modal');
    showNotification('Ø«Ø¨Øª Ø®Ø¯Ù…Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ ğŸ’…âœ…', 'success');
  } catch(e) {
    console.error(e);
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø®Ø¯Ù…Øª', 'error');
  }
}

// --- Save settings ---
async function saveAdminSettings() {
  const salonName = document.getElementById('admin-salon-name').value.trim();
  const salonPhone = document.getElementById('admin-salon-phone').value.trim();
  const salonAddress = document.getElementById('admin-salon-address').value.trim();
  const loyaltyPercent = parseInt(document.getElementById('admin-loyalty-percentage')?.value || '5', 10);
  const referralCount = parseInt(document.getElementById('admin-referral-count')?.value || '3', 10);
  const obj = { salonName, salonPhone, salonAddress, loyaltyPercent, referralCount };
  try {
    await window.fb.saveSettings(obj);
    showNotification('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…', 'success');
  } catch(e) {
    console.error(e);
    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'error');
  }
}
  // ÙØ±Ù… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø§Ø² Firestore Ù¾Ø± Ú©Ù†
  function loadSettingsForm() {
    const s = window.settings || {};
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = (val ?? ''); };
    set('admin-salon-name',  s.salonName);
    set('admin-salon-phone', s.salonPhone);
    set('admin-salon-address', s.salonAddress);
    loadAdminLoyalty(); // Ù‡Ù…Ø²Ù…Ø§Ù† ÙˆÙØ§Ø¯Ø§Ø±ÛŒ Ø±Ø§ Ù‡Ù… Ø³ÛŒÙ†Ú© Ú©Ù†
  }

  // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†Ù Ø§Ù…Ù† Ø¨Ø±Ø§ÛŒ loadAdminLoyalty (Ø¨Ø§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± UI)
  async function loadAdminLoyalty() {
    try {
      const s = window.settings || await window.fb.readSettings();
      const loyalty = document.getElementById('admin-loyalty-percentage');
      const referral = document.getElementById('admin-referral-count');
      if (loyalty)  loyalty.value  = (s.loyaltyPercent ?? 5);
      if (referral) referral.value = (s.referralCount ?? 3);
    } catch (e) {
      console.error('loadAdminLoyalty error', e);
    }
  }
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    setLogLevel, initializeFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs,
    query, where, onSnapshot, updateDoc, serverTimestamp, orderBy, increment
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // === Firebase config (use EXACTLY your project's values) ===
  const firebaseConfig = {
    apiKey: "AIzaSyBYf7X33Cof8IM0uH0Set8Ev1EfAIE4SJ8",
    authDomain: "nasrynnail-crm-f6f80.firebaseapp.com",
    projectId: "nasrynnail-crm-f6f80",
    storageBucket: "nasrynnail-crm-f6f80.appspot.com",
    messagingSenderId: "398579445205",
    appId: "1:398579445205:web:185295d6c9296f4c9ca15c"
  };

  const app = initializeApp(firebaseConfig);
  const db  = initializeFirestore(app, {
    experimentalForceLongPolling: true,
    experimentalLongPollingOptions: { timeoutSeconds: 30 },
    useFetchStreams: false
  });
  setLogLevel('silent');
  const auth = getAuth(app);

  // ---- Simple pretty toast ----
  function showToast(message, type='info'){
    const box = document.getElementById('toast-container');
    const el = document.createElement('div');
    el.className = 'toast ' + (type==='success'?'success':type==='error'?'error':type==='warn'?'warn':'');
    el.innerHTML = '<span class="title">'+(type==='success'?'Ù…ÙˆÙÙ‚':type==='error'?'Ø®Ø·Ø§':type==='warn'?'Ù‡Ø´Ø¯Ø§Ø±':'Ù¾ÛŒØ§Ù…')+'</span> ' + message;
    box.appendChild(el);
    const t = setTimeout(()=>{
      el.style.animation = 'toast-out .2s forwards';
      setTimeout(()=> el.remove(), 180);
      clearTimeout(t);
    }, 3000);
  }
  window.showNotification = (msg, t) => showToast(msg, t);

  // ---- Helpers (Firestore) ----
  async function fbFindCustomerByPhone(phone) {
    const qy = query(collection(db, "customers"), where("phone", "==", phone));
    const s = await getDocs(qy);
    if (s.empty) return null;
    const d = s.docs[0];
    return { id: d.id, ...d.data() };
  }

  async function fbAddCustomer({name, phone, birthday}) {
    if (await fbFindCustomerByPhone(phone)) throw new Error("Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.");
    const ref = await addDoc(collection(db, "customers"), {
      name, phone, birthday: birthday || null,
      visits: 0, balance: 30000, createdAt: serverTimestamp()
    });
    const snap = await getDoc(ref);
    return { id: ref.id, ...snap.data() };
  }

  async function fbAddAppointment(appt) {
    await addDoc(collection(db, "appointments"), { ...appt, createdAt: serverTimestamp() });
  }

  async function fbCancelAppointment(apptId, {reason, suggestedDate, suggestedTime} = {}) {
    const updates = { status: "cancelled" };
    if (reason) updates.cancelReason = reason;
    if (suggestedDate) updates.suggestedDate = suggestedDate;
    if (suggestedTime) updates.suggestedTime = suggestedTime;
    await updateDoc(doc(db, "appointments", apptId), updates);
  }

  async function fbAddServiceRecord({ customerId, serviceType, customServiceType, price, description, cashback, date }) {
    await addDoc(collection(db, "serviceRecords"), {
      customerId, serviceType, customServiceType: customServiceType || null,
      price: Number(price), description: description || "", cashback: Number(cashback || 0),
      date: date || new Date().toISOString(), createdAt: serverTimestamp()
    });
    await updateDoc(doc(db, "customers", customerId), {
      balance: increment(Number(cashback || 0)),
      visits: increment(1)
    });
  }

  async function fbSaveSettings(settingsObj) {
    await setDoc(doc(db, "settings", "main"), { ...settingsObj, updatedAt: serverTimestamp() });
  }
  async function fbReadSettings() {
    const s = await getDoc(doc(db, "settings", "main"));
    return s.exists() ? s.data() : {};
  }

  async function fbAdminLogin(email, password) {
    await signInWithEmailAndPassword(auth, email, password);
    return auth.currentUser;
  }
  async function fbAdminLogout(){ try{ await signOut(auth); }catch(e){} }

  // ---- Realtime for admin (customers) ----
  let _unsubCustomers = null;
  function watchAdminCustomers() {
    if (_unsubCustomers) return;
    const qy = query(collection(db, 'customers'), orderBy('createdAt', 'desc'));
    _unsubCustomers = onSnapshot(qy, (snap) => {
      window.customers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      window.loadAdminCustomers?.();
      window.updateAdminStats?.();
    }, (err)=> console.error('customers onSnapshot error:', err));
  }

  // ---- UI bindings ----
  window.customerRegister = async function customerRegister(){
    const name = document.getElementById('customer-register-name')?.value?.trim();
    const phone = document.getElementById('customer-register-phone')?.value?.trim();
    const birthday = document.getElementById('customer-register-birthday')?.value?.trim();
    if (!name || !phone){ showToast('Ù†Ø§Ù… Ùˆ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª','error'); return; }
    try {
      const newCus = await fbAddCustomer({ name, phone, birthday });
      window.currentUser = newCus;
      window.userType = 'customer';
      window.showCustomerPanel?.();
      window.loadCustomerProfile?.();
      window.loadCustomerAppointments?.();
      window.loadCustomerRecentAppointments?.();
      window.loadCustomerCampaigns?.();
      window.loadCustomerServiceHistory?.();
      showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ ğŸŒ¸','success');
    } catch(e){ console.error(e); showToast(e.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…','error'); }
  };

  window.customerLogin = async function customerLogin(){
    const phone = document.getElementById('customer-login-phone')?.value?.trim();
    if (!phone){ showToast('Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
    try {
      const customer = await fbFindCustomerByPhone(phone);
      if (!customer){ showToast('Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯Ø› Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯.','warn'); return; }
      window.currentUser = customer;
      window.userType = 'customer';
      window.showCustomerPanel?.();
      window.loadCustomerProfile?.();
      window.loadCustomerAppointments?.();
      window.loadCustomerRecentAppointments?.();
      window.loadCustomerCampaigns?.();
      window.loadCustomerServiceHistory?.();
      showToast('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ ğŸŒŸ','success');
    } catch(e){ console.error(e); showToast('Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯','error'); }
  };

  window.adminLogin = async function adminLogin(){
    const email = document.getElementById('admin-username')?.value?.trim();
    const password = document.getElementById('admin-password')?.value?.trim();
    try {
      await fbAdminLogin(email, password);
      window.userType = 'admin';
      watchAdminCustomers();
      window.showAdminPanel?.();
      showToast('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª âš™ï¸','success');
    } catch(e){ console.error(e); showToast('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª','error'); }
  };

  window.logout = async function logout(){
    await fbAdminLogout();
    window.currentUser = null; window.userType = null;
    window.showAuthScreen?.();
    ['customer-login-phone','customer-register-name','customer-register-phone','customer-register-birthday','admin-username','admin-password']
      .forEach(id => { const el = document.getElementById(id); if (el) el.value=''; });
    showToast('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚ ğŸ‘‹','success');
  };

  window.bookAppointment = async function bookAppointment(){
    if (!window.currentUser){ showToast('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯','error'); return; }
    const date = document.getElementById('book-appointment-date')?.value;
    const time = document.getElementById('book-appointment-time')?.value;
    const service = document.getElementById('book-appointment-service')?.value;
    const notes = document.getElementById('book-appointment-notes')?.value?.trim();
    const additionalServices = [];
    if (document.getElementById('additional-french')?.checked) additionalServices.push('french');
    if (document.getElementById('additional-ombre')?.checked) additionalServices.push('ombre');
    if (document.getElementById('additional-galaxy')?.checked) additionalServices.push('galaxy-gel');
    if (document.getElementById('additional-lens')?.checked) additionalServices.push('lens-chrome');
    if (!date || !time){ showToast('ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return; }
    const appt = {
      id: crypto.randomUUID(),
      customerId: window.currentUser.id,
      service, additionalServices, notes,
      status: 'pending',
      datetime: new Date().toISOString(),
      persianDate: date, persianTime: time,
      createdAt: new Date().toISOString()
    };
    try { await fbAddAppointment(appt); window.closeModal?.('book-appointment-modal'); showToast('Ù†ÙˆØ¨Øª Ø«Ø¨Øª Ø´Ø¯ âœ…','success'); }
    catch(e){ console.error(e); showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†ÙˆØ¨Øª','error'); }
  };

  window.cancelCustomerAppointment = function cancelCustomerAppointment(apptId){
    window._cancelApptId = apptId; window.openModal?.('cancel-appointment-modal');
  };
  window.confirmCancelAppointment = async function confirmCancelAppointment(){
    const reason = document.getElementById('cancel-reason')?.value?.trim();
    const suggestedDate = document.getElementById('suggested-date')?.value;
    const suggestedTime = document.getElementById('suggested-time')?.value;
    if(!window._cancelApptId) return;
    try {
      await fbCancelAppointment(window._cancelApptId, {reason, suggestedDate, suggestedTime});
      window.closeModal?.('cancel-appointment-modal');
      showToast('Ù†ÙˆØ¨Øª Ù„ØºÙˆ Ø´Ø¯ âŒ','success');
    } catch(e){ console.error(e); showToast('Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù†ÙˆØ¨Øª','error'); }
    finally { window._cancelApptId = null; }
  };

  // Keep UI synced with Auth for admin refreshes
  onAuthStateChanged(auth, (user)=>{
    if (user && window.userType === 'admin'){ watchAdminCustomers(); window.showAdminPanel?.(); }
  });

  // Expose for debugging
  window.fb = { db, auth, fbFindCustomerByPhone, fbAddCustomer, fbAddAppointment, fbCancelAppointment, fbSaveSettings, fbReadSettings };
</script>
</body>
</html>

